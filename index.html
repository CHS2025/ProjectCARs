<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    #header {
      text-align: center;
      margin: 20px 0;
      padding: 20px;
      background: linear-gradient(135deg, #2193b0, #6dd5ed);
      border-radius: 8px;
      color: white;
    }
    #header img {
      max-width: 120px;
      margin-bottom: 15px;
      border-radius: 0;
      box-shadow: none;
      background: transparent;
      padding: 10px;
      object-fit: contain;
    }
    #header h1 {
      font-size: 28px;
      color: white;
      margin: 0 0 10px 0;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    #header h2 {
      font-size: 22px;
      color: rgba(255,255,255,0.9);
      margin: 0;
      font-weight: normal;
    }
    #loginForm, #landingPage {
      width: 90%;
      max-width: 600px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: opacity 0.3s ease-in-out;
    }
    #landingPage {
      width: 100%;
      max-width: none;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      border-radius: 0;
      box-shadow: none;
      transition: opacity 0.3s ease-in-out;
      display: none; /* Hidden by default */
      opacity: 0;
    }
    h2 {
      color: #333;
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
    }
    input[type="text"], input[type="password"], select, textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    input[type="button"], button {
      background-color: #007BFF;
      color: #fff;
      border: none;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    input[type="button"]:hover, button:hover {
      background-color: #0056b3;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      overflow: auto; /* Allow auto overflow */
    }
    .modal-content {
      background: linear-gradient(135deg, #ffffff 0%, #f5f7fa 100%);
      margin: 5% auto;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      position: relative;
      width: 95%;
      max-width: 1200px; /* Increased for Setup Role modal */
      animation: modalSlideIn 0.3s ease-out;
    }

    /* Add specific styles for Setup Role modal */
    #setupRoleModal .modal-content {
      max-width: 1200px;
      width: 95%;
      margin: 2% auto;
    }

    #setupRoleModal .modal-content table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    #setupRoleModal .modal-content th,
    #setupRoleModal .modal-content td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
      white-space: nowrap;
    }

    #setupRoleModal .modal-content th {
      background-color: #f5f7fa;
      color: #1e3c72;
      font-weight: 600;
    }

    #setupRoleModal .modal-content tr:hover {
      background-color: #f8f9fa;
    }

    #setupRoleModal .modal-content select {
      width: 150px;
      padding: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background-color: white;
    }

    /* Add responsive styles for the Setup Role modal */
    @media (max-width: 768px) {
      #setupRoleModal .modal-content {
        margin: 0;
        width: 100%;
        height: 100%;
        border-radius: 0;
      }

      #setupRoleModal .modal-content table {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      #setupRoleModal .modal-content th,
      #setupRoleModal .modal-content td {
        min-width: 120px;
      }
    }

    /* Adjust the close button position for larger modal */
    #setupRoleModal .close {
      position: absolute;
      right: 20px;
      top: 20px;
      font-size: 28px;
      font-weight: bold;
      color: #666;
      cursor: pointer;
      transition: color 0.3s;
      z-index: 1;
    }

    #setupRoleModal .close:hover {
      color: #2193b0;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 24px;
      font-weight: bold;
    }
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
    #loadingOverlay {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.3s ease-in-out;
    }
    .spinner {
      border: 16px solid #f3f3f3;
      border-top: 16px solid #3498db;
      border-radius: 50%;
      width: 80px;
      height: 80px;
      animation: spin 1.5s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .record-container {
      margin-top: 20px;
    }
    .record-item {
      margin-bottom: 20px;
    }
    .navigation-buttons {
      text-align: center;
      margin-top: 20px;
    }
    .navigation-buttons button {
      margin: 0 10px;
      padding: 10px 20px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .navigation-buttons button:disabled {
      background-color: #ddd;
      cursor: not-allowed;
    }
    .record-indicator {
      text-align: center;
      margin-top: 10px;
      font-size: 16px;
      color: #555;
    }
    @media (max-width: 768px) {
      #header img {
        max-width: 120px;
      }
      #header h1 {
        font-size: 24px;
      }
      input[type="button"] {
        font-size: 14px;
        padding: 8px;
      }
      .modal-content {
        width: 95%; /* Adjust for smaller screens */
        max-width: none; /* Remove max-width on smaller screens */
      }
    }

    /* Instructions Styles */
    .instructions {
      background: white;
      margin: 30px 40px;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    }
    
    .instructions h3 {
      color: #333;
      margin-bottom: 10px;
    }

    .instructions ol {
      margin-left: 20px;
      color: #555;
    }

    .instructions ol li {
      margin-bottom: 10px;
    }

    /* Dashboard Styles */
    .dashboard-header {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      padding: 25px 40px;
      border-radius: 0 0 20px 20px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    /* User Info Section */
    .user-info {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .project-title h1 {
      color: white;
      margin: 0;
      font-size: 28px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .welcome-section {
      display: flex;
      align-items: center;
      gap: 15px;
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }

    .user-avatar {
      background: rgba(255, 255, 255, 0.2);
      padding: 12px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .user-avatar i {
      font-size: 2em;
      color: white;
    }

    .user-details {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .user-details h3 {
      color: rgba(255, 255, 255, 0.9);
      margin: 0;
      font-size: 16px;
      font-weight: normal;
    }

    .user-details h2 {
      color: white;
      margin: 0;
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    /* Header Right Section */
    .header-right {
      display: flex;
      flex-direction: column;
      gap: 15px;
      align-items: flex-end; /* Change to flex-end to align to the right */
    }

    /* Button Container */
    .header-actions {
      display: flex;
      gap: 12px;
      margin-top: 0;
      justify-content: flex-end; /* Align buttons to the right */
    }

    /* Button Styles */
    .setup-role-btn {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 10px 20px;
      color: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .setup-role-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
    }

    .change-password-btn {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 10px 20px;
      color: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .change-password-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
    }

    .logout-btn {
      background: rgba(220, 53, 69, 0.9);
      border: none;
      padding: 10px 20px;
      color: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .logout-btn:hover {
      background: rgba(220, 53, 69, 1);
      transform: translateY(-2px);
    }

    /* Date Time Display */
    .date-time {
      color: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1em;
      background: rgba(255, 255, 255, 0.1);
      padding: 8px 15px;
      border-radius: 8px;
      backdrop-filter: blur(10px);
      margin-top: 15px;
      align-self: flex-end; /* Align date/time to the right */
    }

    .date-time i {
      color: rgba(255, 255, 255, 0.8);
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .header-right {
        width: 100%;
        align-items: center;
      }

      .header-actions {
        flex-direction: column;
        width: 100%;
      }

      .date-time {
        width: 100%;
        justify-content: center;
      }
    }

    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 0 40px 30px 40px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.07);
      transition: transform 0.3s ease;
      position: relative;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-card i {
      font-size: 2em;
      color: #2193b0;
      background: rgba(33, 147, 176, 0.1);
      padding: 15px;
      border-radius: 10px;
    }

    .stat-info h3 {
      margin: 0;
      font-size: 0.9em;
      color: #666;
    }

    .stat-info p {
      margin: 5px 0 0 0;
      font-size: 1.8em;
      font-weight: bold;
      color: #333;
    }

    /* Enhanced Dashboard Cards */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      padding: 0 40px;
      margin-bottom: 30px;
    }

    .dashboard-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      gap: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    }

    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    }

    .card-icon {
      background: rgba(33, 147, 176, 0.1);
      padding: 20px;
      border-radius: 12px;
    }

    .card-icon i {
      font-size: 2em;
      color: #2193b0;
    }

    .card-content {
      flex: 1;
    }

    .card-content h3 {
      margin: 0;
      color: #333;
      font-size: 1.2em;
    }

    .card-content p {
      margin: 5px 0 0 0;
      color: #666;
      font-size: 0.9em;
    }

    .card-arrow {
      color: #2193b0;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .dashboard-card:hover .card-arrow {
      opacity: 1;
      transform: translateX(5px);
    }

    /* Quick Actions */
    .quick-actions {
      background: white;
      margin: 30px 20px;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    }

    .quick-actions h3 {
      margin: 0 0 20px 0;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .action-buttons button {
      background: #f8f9fa;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .action-buttons button:hover {
      background: #e9ecef;
      transform: translateY(-2px);
    }

    /* Enhanced Instructions */
    .instructions {
      background: white;
      margin: 30px 40px;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    }

    .instruction-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .instruction-card {
      text-align: center;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .instruction-card:hover {
      transform: translateY(-5px);
      background: #e9ecef;
    }

    .instruction-card i {
      font-size: 2em;
      color: #2193b0;
      margin-bottom: 15px;
    }

    .instruction-card h4 {
      margin: 0 0 10px 0;
      color: #333;
    }

    .instruction-card p {
      margin: 0;
      color: #666;
      font-size: 0.9em;
    }

    @media (max-width: 768px) {
      .dashboard-header {
        flex-direction: column;
        text-align: center;
        gap: 20px;
      }

      .header-actions {
        flex-direction: column;
        gap: 15px;
      }

      .dashboard-stats {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }

      .instruction-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Improved Form Styles */
    .report-form .record-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }

    .report-form .record-row {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 4px;
      background: #f8f9fa;
    }

    .report-form .record-field {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .report-form label {
      margin-bottom: 8px;
      color: #495057;
      font-size: 0.9em;
      text-transform: uppercase;
    }

    .report-form input[type="text"],
    .report-form select,
    .report-form textarea {
      padding: 10px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 1em;
      width: 100%;
      background: white;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    .report-form textarea {
      min-height: 100px;
      resize: vertical;
    }

    .report-form input[type="text"]:focus,
    .report-form select:focus,
    .report-form textarea:focus {
      border-color: #2193b0;
      box-shadow: 0 0 0 0.2rem rgba(33, 147, 176, 0.25);
      outline: none;
    }

    .report-form .submit-field {
      display: flex;
      justify-content: flex-end;
    }

    .report-form .submit-btn {
      background: #2193b0;
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s ease;
    }

    .report-form .submit-btn:hover {
      background: #1a7a8c;
      transform: translateY(-2px);
    }

    .report-form .record-row.footer {
      background: #e9ecef;
      margin-top: 20px;
      margin-bottom: 0;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .report-form .record-row {
        flex-direction: column;
        gap: 15px;
      }

      .report-form .record-field {
        width: 100%;
      }
    }

    /* Change Password Button Styles */
    .change-password-btn {
      background: #2193b0;
      border: none;
      padding: 10px 20px;
      color: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .change-password-btn:hover {
      background: #1a7a8c;
      transform: translateY(-2px);
    }

    /* Add this new style for the body when dashboard is shown */
    body.dashboard-active {
      background: #f4f4f4;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    /* Update the header-actions style */
    .header-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    /* Add styles for the main actions */
    .main-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      padding: 20px 40px;
      margin-bottom: 30px;
    }

    .main-action-btn {
      background: #2193b0;
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.1em;
      justify-content: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .main-action-btn:hover {
      background: #1a7a8c;
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .main-action-btn i {
      font-size: 1.2em;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .main-actions {
        grid-template-columns: 1fr;
        padding: 15px;
      }
      
      .main-action-btn {
        padding: 12px 20px;
        font-size: 1em;
      }
    }

    /* Record Display Styles */
    .record-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .record-row {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 4px;
      background: #f8f9fa;
    }

    .record-row.full-width {
      flex-direction: column;
    }

    .record-row.footer {
      background: #e9ecef;
      margin-top: 20px;
      margin-bottom: 0;
    }

    .record-field {
      flex: 1;
    }

    .record-field strong {
      color: #495057;
      font-size: 0.9em;
      text-transform: uppercase;
      display: block;
      margin-bottom: 5px;
    }

    .record-row.full-width .record-field {
      white-space: pre-line;
      line-height: 1.5;
    }

    /* Search Input Styling */
    #searchQuery, #clinicSearchQuery {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 1em;
      transition: border-color 0.3s;
    }

    #searchQuery:focus, #clinicSearchQuery:focus {
      outline: none;
      border-color: #2193b0;
      box-shadow: 0 0 0 0.2rem rgba(33,147,176,.25);
    }

    /* Navigation Buttons Styling */
    .navigation-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }

    .navigation-buttons button {
      padding: 8px 20px;
      background: #2193b0;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .navigation-buttons button:hover:not(:disabled) {
      background: #1a7a8c;
    }

    .navigation-buttons button:disabled {
      background: #e9ecef;
      cursor: not-allowed;
    }

    .record-indicator {
      text-align: center;
      margin-top: 10px;
      color: #6c757d;
      font-size: 0.9em;
    }

    .no-records {
      text-align: center;
      padding: 20px;
      color: #6c757d;
      font-style: italic;
      background: #f8f9fa;
      border-radius: 4px;
      margin: 20px 0;
    }

    /* Modal Content Styling */
    .modal-content {
      background-color: #fefefe;
      margin: 2% auto;
      padding: 25px;
      border: none;
      width: 90%;
      max-width: 900px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .modal-content h2 {
      color: #2193b0;
      margin-bottom: 25px;
      font-size: 1.5em;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .record-row {
        flex-direction: column;
        gap: 10px;
      }

      .modal-content {
        margin: 5% auto;
        padding: 20px;
        width: 95%;
      }

      .navigation-buttons {
        flex-direction: column;
        align-items: center;
      }

      .navigation-buttons button {
        width: 100%;
        max-width: 200px;
      }
    }

    /* Add these styles */
    .setup-role-btn {
      background: #4CAF50;
      border: none;
      padding: 10px 20px;
      color: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .setup-role-btn:hover {
      background: #45a049;
      transform: translateY(-2px);
    }

    .user-roles-container {
      margin-top: 20px;
      overflow-x: auto;
    }

    .user-roles-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: white;
    }

    .user-roles-table th {
      background: #2193b0;
      color: white;
      padding: 12px;
      text-align: left;
    }

    .user-roles-table td {
      padding: 12px;
      border-bottom: 1px solid #dee2e6;
    }

    .user-roles-table tr:hover {
      background-color: #f8f9fa;
    }

    .role-select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }

    .save-role-btn {
      background: #2193b0;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }

    .save-role-btn:hover {
      background: #1a7a8c;
    }

    /* Update the date-time style */
    .date-time {
      color: white;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.1em;
      margin-top: 15px;
      justify-content: flex-end;
    }

    .date-time i {
      font-size: 1.2em;
    }

    /* Update the header-actions style */
    .header-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    /* Update responsive styles */
    @media (max-width: 768px) {
      .dashboard-header {
        flex-direction: column;
        text-align: center;
        gap: 20px;
        padding: 20px;
      }

      .header-right {
        width: 100%;
        align-items: center;
      }

      .header-actions {
        flex-direction: column;
        width: 100%;
      }

      .header-actions button {
        width: 100%;
      }

      .date-time {
        justify-content: center;
      }
    }

    /* Add header-right container style */
    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
    }

    /* Update the header-actions style */
    .header-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    /* Update the date-time style */
    .date-time {
      color: white;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.1em;
      margin-top: 15px;
      justify-content: flex-end;
    }

    .date-time i {
      font-size: 1.2em;
    }

    .date-filter {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }

    .date-inputs {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }

    .date-field {
      flex: 1;
    }

    .date-field label {
      display: block;
      margin-bottom: 5px;
      color: #495057;
      font-weight: bold;
    }

    .date-field input[type="date"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }

    .filter-btn {
      background: #2193b0;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-btn:hover {
      background: #1a7a8c;
    }

    .search-filter-container {
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }

    .search-container {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .search-container input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }

    .search-container button {
      white-space: nowrap;
    }

    #searchQuery {
      width: 100%;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      margin-bottom: 10px;
    }

    .filter-btn {
      background: #2193b0;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-btn:hover {
      background: #1a7a8c;
    }

    /* Add these styles for the project title */
    .project-title {
      margin-bottom: 15px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 10px;
      width: 100%;
    }

    .project-title h1 {
      font-size: 28px;
      color: white;
      margin: 0;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
      font-weight: bold;
    }

    /* Update the user-info styles */
    .user-info {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }

    /* Responsive styles */
    @media (max-width: 768px) {
      .project-title h1 {
        font-size: 24px;
        text-align: center;
      }
      
      .user-info {
        align-items: center;
      }
    }

    /* Add these styles for the tooltip */
    .stat-card {
      position: relative;
    }

    .tooltip {
      display: none;
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 100;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-top: 10px;
      min-width: 200px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .tooltip::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 0 6px 6px 6px;
      border-style: solid;
      border-color: transparent transparent rgba(0, 0, 0, 0.8) transparent;
    }

    .tooltip-content {
      text-align: left;
    }

    .tooltip-content p {
      margin: 5px 0;
      color: white;
    }

    .stat-card:hover .tooltip {
      display: block;
    }

    /* Add or update these responsive styles */

    /* General responsive styles */
    @media (max-width: 1024px) {
      .dashboard-stats {
        grid-template-columns: repeat(2, 1fr);
        padding: 15px;
      }

      .main-actions {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        padding: 15px;
      }
    }

    @media (max-width: 768px) {
      /* Header styles */
      .dashboard-header {
        flex-direction: column;
        padding: 15px;
        gap: 15px;
      }

      .header-right {
        width: 100%;
      }

      .header-actions {
        flex-direction: column;
        width: 100%;
        gap: 10px;
      }

      .header-actions button {
        width: 100%;
      }

      .date-time {
        justify-content: center;
        margin-top: 10px;
      }

      /* Project title */
      .project-title h1 {
        font-size: 20px;
        text-align: center;
      }

      /* User info */
      .user-info {
        align-items: center;
        text-align: center;
      }

      .user-details h2 {
        font-size: 18px;
      }

      .user-details h3 {
        font-size: 16px;
      }

      /* Stats cards */
      .dashboard-stats {
        grid-template-columns: 1fr;
        gap: 15px;
        margin: 15px;
      }

      .stat-card {
        padding: 15px;
      }

      /* Action buttons */
      .main-actions {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 15px;
      }

      .main-action-btn {
        width: 100%;
      }

      /* Modal content */
      .modal-content {
        width: 95%;
        margin: 10px auto;
        padding: 15px;
      }

      /* Form inputs */
      input[type="text"], 
      input[type="password"], 
      input[type="email"],
      select, 
      textarea {
        font-size: 16px; /* Prevents zoom on mobile */
      }

      /* Search and filter container */
      .search-filter-container {
        padding: 10px;
      }

      .date-inputs {
        flex-direction: column;
        gap: 10px;
      }

      .search-container {
        flex-direction: column;
        gap: 10px;
      }

      .search-container button {
        width: 100%;
      }

      /* Record display */
      .record-card {
        padding: 10px;
      }

      .record-row {
        flex-direction: column;
        gap: 10px;
      }

      .record-field {
        width: 100%;
      }

      /* Navigation buttons */
      .navigation-buttons {
        flex-direction: column;
        gap: 10px;
      }

      .navigation-buttons button {
        width: 100%;
      }
    }

    /* Small mobile devices */
    @media (max-width: 480px) {
      .project-title h1 {
        font-size: 18px;
      }

      .stat-info h3 {
        font-size: 14px;
      }

      .stat-info p {
        font-size: 20px;
      }

      .modal-content {
        padding: 10px;
      }

      .tooltip {
        min-width: 150px;
        font-size: 12px;
      }
    }

    /* Landscape orientation */
    @media (max-height: 600px) and (orientation: landscape) {
      .modal-content {
        max-height: 85vh;
        overflow-y: auto;
      }

      .dashboard-header {
        padding: 10px;
      }
    }

    /* High-resolution displays */
    @media (min-width: 1440px) {
      .dashboard-stats {
        max-width: 1400px;
        margin: 30px auto;
      }

      .main-actions {
        max-width: 1400px;
        margin: 30px auto;
      }
    }

    .user-roles-form {
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #495057;
    }

    .role-select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 16px;
    }

    .user-details {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #dee2e6;
    }

    .save-role-btn {
      background: #2193b0;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 20px;
    }

    .save-role-btn:hover {
      background: #1a7a8c;
    }

    .footer-note {
      text-align: center;
      padding: 20px;
      color: #666;
      font-size: 14px;
      margin-top: 40px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      backdrop-filter: blur(10px);
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
    }

    .footer-note span {
      font-style: italic;
    }

    /* Add these styles to your existing CSS */
    .registration-progress {
      text-align: center;
      padding: 20px;
    }

    .registration-success {
      text-align: center;
      padding: 20px;
    }

    #registrationForm {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    #registrationForm input {
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    #registrationForm input:focus {
      border-color: #2193b0;
      box-shadow: 0 0 0 2px rgba(33, 147, 176, 0.2);
      outline: none;
    }

    #registrationForm input[type="button"] {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    #registrationForm input[type="button"]:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(33, 147, 176, 0.3);
    }

    #registrationForm label {
      font-weight: 500;
      color: #333;
      margin-bottom: 5px;
    }

    .reg-form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }

    .reg-form-row .input-group {
      flex: 1;
    }

    .input-group {
      position: relative;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      color: #1e3c72;
      font-size: 13px;
      font-weight: 500;
    }

    .input-group input {
      width: 100%;
      padding: 8px 12px 8px 35px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .input-group input:focus {
      border-color: #2193b0;
      box-shadow: 0 2px 5px rgba(33, 147, 176, 0.2);
      outline: none;
    }

    .input-group i {
      position: absolute;
      left: 12px;
      top: 32px;
      color: #666;
      font-size: 14px;
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
      .reg-form-row {
        flex-direction: column;
        gap: 15px;
      }
    }

    .title-with-logo {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .title-with-logo img {
      width: 50px;
      height: auto;
      border-radius: 8px;
    }

    .title-with-logo h1 {
      margin: 0;
      color: white;
      font-size: 28px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    /* Add responsive styles */
    @media (max-width: 768px) {
      .title-with-logo {
        justify-content: center;
      }
      
      .title-with-logo img {
        width: 40px;
      }
      
      .title-with-logo h1 {
        font-size: 22px;
      }
    }

    .login-progress {
      text-align: center;
      padding: 20px;
    }

    .login-progress i {
      animation: pulse 1.5s infinite;
    }

    .login-success {
      text-align: center;
      padding: 20px;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
      100% {
        transform: scale(1);
      }
    }

    .dashboard-active #landingPage {
      opacity: 1;
    }

    /* Add these styles to your existing CSS */
    #forgotPasswordModal .modal-content {
      max-width: 350px; /* Reduced from 400px */
      padding: 20px;
    }

    .forgot-password-header {
      text-align: center;
      margin-bottom: 15px;
    }

    .forgot-password-header h2 {
      color: #1e3c72;
      margin: 8px 0;
      font-size: 20px;
    }

    .forgot-password-header .subtitle {
      color: #666;
      font-size: 13px;
      margin: 0;
      line-height: 1.3;
    }

    #forgotPasswordForm {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    #forgotPasswordForm .input-group {
      margin: 0;
      width: 100%; /* Ensure the input group takes full width of its container */
    }

    #forgotPasswordForm .input-with-icon {
      position: relative;
      width: 100%; /* Ensure the input wrapper takes full width */
    }

    #forgotPasswordForm input[type="email"] {
      width: calc(100% - 35px); /* Subtract the space needed for the icon */
      padding: 8px 12px 8px 35px;
      height: 35px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      background-color: #f8f9fa;
      box-sizing: border-box; /* Include padding in width calculation */
    }

    #forgotPasswordForm .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    #forgotPasswordForm .form-actions button {
      flex: 1;
      padding: 8px;
      height: 35px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    #forgotPasswordForm .input-with-icon i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
      font-size: 14px;
      line-height: 1;
      z-index: 1;
    }

    /* Add this to your CSS if not already present */
    .required-field::after {
      content: ' *';
      color: #ff4444;
      font-weight: bold;
      margin-left: 2px;
    }

    .input-group label.required-field {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .input-group input:required,
    .input-group select:required,
    .input-group textarea:required {
      background-color: #fff;
      border-color: #e0e0e0;
    }

    .input-group input:required:focus,
    .input-group select:required:focus,
    .input-group textarea:required:focus {
      border-color: #2193b0;
      box-shadow: 0 0 0 3px rgba(33, 147, 176, 0.1);
    }

    /* Update Add Report form fields */
    <div class="form-section student-info">
      <h3>Student Information</h3>
      <div class="input-group">
        <label for="studentNumber" class="required-field">Student Number</label>
        <input type="text" id="studentNumber" name="studentNumber" required>
      </div>
      <div class="input-group">
        <label for="gradeLevel" class="required-field">Grade Level</label>
        <select id="gradeLevel" name="gradeLevel" required>
          <option value="">Select Grade Level</option>
        </select>
      </div>
      <div class="input-group">
        <label for="section" class="required-field">Section</label>
        <input type="text" id="section" name="section" required>
      </div>
      <div class="input-group">
        <label for="firstName" class="required-field">First Name</label>
        <input type="text" id="firstName" name="firstName" required>
      </div>
      <div class="input-group">
        <label for="lastName" class="required-field">Last Name</label>
        <input type="text" id="lastName" name="lastName" required>
      </div>
      <div class="input-group">
        <label for="suffix">Suffix</label>
        <input type="text" id="suffix" name="suffix">
      </div>
    </div>

    <div class="form-section">
      <h3>Report Details</h3>
      <div class="input-group">
        <label for="issuesConcern" class="required-field">Issues and Concern</label>
        <textarea id="issuesConcern" name="issuesConcern" required></textarea>
      </div>
    </div>

    <div class="form-section full-width">
      <div class="input-group">
        <label for="description" class="required-field">Description</label>
        <textarea id="description" name="description" required></textarea>
      </div>
      <div class="input-group">
        <label for="actionTaken" class="required-field">Action Taken</label>
        <textarea id="actionTaken" name="actionTaken" required></textarea>
      </div>
      <div class="input-group">
        <label for="recommendation" class="required-field">Recommendation</label>
        <textarea id="recommendation" name="recommendation" required></textarea>
      </div>
    </div>

    /* Update Add Clinic Report form fields */
    <div class="form-section student-info">
      <h3>Student Information</h3>
      <div class="input-group">
        <label for="clinicStudentNumber" class="required-field">Student Number</label>
        <input type="text" id="clinicStudentNumber" name="clinicStudentNumber" required>
      </div>
      <div class="input-group">
        <label for="clinicGradeLevel" class="required-field">Grade Level</label>
        <select id="clinicGradeLevel" name="clinicGradeLevel" required>
          <option value="">Select Grade Level</option>
          <option value="Grade 7">Grade 7</option>
          <option value="Grade 8">Grade 8</option>
          <option value="Grade 9">Grade 9</option>
          <option value="Grade 10">Grade 10</option>
          <option value="Grade 11">Grade 11</option>
          <option value="Grade 12">Grade 12</option>
        </select>
      </div>
      <div class="input-group">
        <label for="clinicSection" class="required-field">Section</label>
        <input type="text" id="clinicSection" name="clinicSection" required>
      </div>
      <div class="input-group">
        <label for="clinicFirstName" class="required-field">First Name</label>
        <input type="text" id="clinicFirstName" name="clinicFirstName" required>
      </div>
      <div class="input-group">
        <label for="clinicLastName" class="required-field">Last Name</label>
        <input type="text" id="clinicLastName" name="clinicLastName" required>
      </div>
      <div class="input-group">
        <label for="clinicSuffix">Suffix</label>
        <input type="text" id="clinicSuffix" name="clinicSuffix">
      </div>
    </div>

    <div class="form-section">
      <h3>Clinic Report Details</h3>
      <div class="input-group">
        <label for="clinicIssuesConcern" class="required-field">Issues and Concern</label>
        <textarea id="clinicIssuesConcern" name="clinicIssuesConcern" required></textarea>
      </div>
    </div>

    <div class="form-section full-width">
      <div class="input-group">
        <label for="clinicDescription" class="required-field">Description</label>
        <textarea id="clinicDescription" name="clinicDescription" required></textarea>
      </div>
      <div class="input-group">
        <label for="clinicActionTaken" class="required-field">Action Taken</label>
        <textarea id="clinicActionTaken" name="clinicActionTaken" required></textarea>
      </div>
      <div class="input-group">
        <label for="clinicRecommendation" class="required-field">Recommendation</label>
        <textarea id="clinicRecommendation" name="clinicRecommendation" required></textarea>
      </div>
    </div>

    /* ... existing styles ... */

    /* Report by Role Modal Styles */
    .role-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      padding: 20px;
    }

    .role-stat-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }

    .role-stat-card:hover {
      transform: translateY(-5px);
    }

    .role-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .role-header i {
      font-size: 24px;
      color: #4CAF50;
      background: rgba(76, 175, 80, 0.1);
      padding: 12px;
      border-radius: 50%;
    }

    .role-header h3 {
      margin: 0;
      color: #333;
      font-size: 1.2em;
    }

    .stat-numbers {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      background: #f8f9fa;
    }

    .stat-item.total {
      background: #4CAF50;
      color: white;
    }

    .stat-label {
      font-size: 0.9em;
      color: inherit;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 1.5em;
      font-weight: bold;
      color: inherit;
    }

    .user-stats-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .user-stats-table th,
    .user-stats-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    .user-stats-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
    }

    .user-stats-table tr:hover {
      background: #f8f9fa;
    }

    .view-btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9em;
      transition: all 0.3s;
    }

    .view-btn:hover {
      background: #45a049;
      transform: translateY(-2px);
    }

    .search-bar {
      margin: 20px;
    }

    .search-bar input {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1em;
      transition: border-color 0.3s;
    }

    .search-bar input:focus {
      outline: none;
      border-color: #4CAF50;
    }

    .tab-navigation {
      display: flex;
      gap: 10px;
      padding: 20px;
      border-bottom: 1px solid #eee;
    }

    .tab-btn {
      padding: 10px 20px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 1em;
      color: #666;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
    }

    .tab-btn:hover {
      color: #4CAF50;
    }

    .tab-btn.active {
      color: #4CAF50;
      border-bottom-color: #4CAF50;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
      .role-stats-grid {
        grid-template-columns: 1fr;
      }
      
      .stat-numbers {
        grid-template-columns: 1fr;
      }
      
      .user-stats-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      
      .tab-navigation {
        flex-direction: column;
      }
      
      .tab-btn {
        width: 100%;
        text-align: center;
      }
    }

    /* ... existing styles ... */

    .records-table-container {
      margin-top: 20px;
      overflow-x: auto;
    }

    .records-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .records-table th,
    .records-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    .records-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
      white-space: nowrap;
    }

    .records-table td {
      color: #666;
    }

    .records-table tr:hover {
      background: #f8f9fa;
    }

    .navigation-buttons {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      padding: 10px;
    }

    .navigation-buttons button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9em;
      transition: all 0.3s;
    }

    .navigation-buttons button:hover:not(:disabled) {
      background: #45a049;
      transform: translateY(-2px);
    }

    .navigation-buttons button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #pageInfo {
      color: #666;
      font-size: 0.9em;
    }

    /* Responsive styles */
    @media (max-width: 768px) {
      .records-table {
        font-size: 14px;
      }
      
      .records-table th,
      .records-table td {
        padding: 8px 10px;
      }
      
      .navigation-buttons {
        flex-direction: column;
        gap: 10px;
      }
      
      .navigation-buttons button {
        width: 100%;
        justify-content: center;
      }
    }

    /* ... existing styles ... */
  </style>
  <script>
    // API Configuration
    const API_URL = 'https://script.google.com/macros/s/AKfycbwq0lQshOY8-LfpJ9rZDZrl0oiecspjQnilFBb4K0RtNlC_SvdXJx9hZtZOb5_wXEr5yQ/exec';

    // Replace all google.script.run calls with fetch API calls
    async function checkLogin() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        try {
            const response = await fetch(`${API_URL}?path=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
            const data = await response.json();
            handleLoginResponse(data);
        } catch (error) {
            showError('Login failed: Network error');
        }
    }

    async function getGradeLevels() {
        try {
            const response = await fetch(`${API_URL}?path=gradeLevels`);
            const data = await response.json();
            populateGradeLevels(data);
        } catch (error) {
            console.error('Failed to fetch grade levels:', error);
        }
    }

    async function getSections(gradeLevel) {
        try {
            const response = await fetch(`${API_URL}?path=sections&gradeLevel=${encodeURIComponent(gradeLevel)}`);
            const data = await response.json();
            populateSections(data);
        } catch (error) {
            console.error('Failed to fetch sections:', error);
        }
    }

    async function saveReport(reportData) {
        try {
            const response = await fetch(`${API_URL}?path=saveReport`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(reportData)
            });
            const data = await response.json();
            handleReportSaved(data);
        } catch (error) {
            showError('Failed to save report');
        }
    }

    async function getDashboardStats() {
        try {
            const response = await fetch(`${API_URL}?path=dashboard`);
            const data = await response.json();
            updateDashboard(data);
        } catch (error) {
            console.error('Failed to fetch dashboard stats:', error);
        }
    }

    // Add more API function conversions as needed...
    
    // Helper function to show errors
    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        } else {
            alert(message);
        }
    }

    // ...existing helper functions and event handlers...
</script>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">Loading...</div>
  </div>

  <!-- Login Form -->
  <div id="loginForm">
    <div id="header">
      <img src="chslogo.png" alt="Culiat High School Logo">
      <h1>Culiat High School</h1>
      <h2>Student Anecdotal Records</h2>
    </div>
    <h2>Login</h2>
    <form>
      <label for="username">Username:</label><br>
      <input type="text" id="username" name="username" required><br><br>
      <label for="password">Password:</label><br>
      <input type="password" id="password" name="password" required><br><br>
      <!-- Add this inside your login form, after the password input -->
      <div style="text-align: right; margin: 10px 0;">
        <a onclick="showForgotPasswordModal(); return false;" style="color: #2193b0; text-decoration: none; font-size: 14px; cursor: pointer;">
          Forgot Password?
        </a>
      </div>
      <input type="button" value="Login" onclick="login()">
      <input type="button" value="Register" onclick="showRegistrationModal()">
    </form>
    <div id="message"></div>
  </div>

  <!-- Registration Modal -->
  <div id="registrationModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('registrationModal')">&times;</span>
      <h2>Create Account</h2>
      <form id="registrationForm">
        <div class="reg-form-row">
          <div class="input-group">
            <label for="regUsername">Username</label>
            <i class="fas fa-user"></i>
            <input type="text" id="regUsername" name="regUsername" required>
          </div>
          
          <div class="input-group">
            <label for="regPassword">Password</label>
            <i class="fas fa-lock"></i>
            <input type="password" id="regPassword" name="regPassword" required>
          </div>
        </div>

        <div class="reg-form-row">
          <div class="input-group">
            <label for="regFirstName">First Name</label>
            <i class="fas fa-user-edit"></i>
            <input type="text" id="regFirstName" name="regFirstName" required>
          </div>
          
          <div class="input-group">
            <label for="regLastName">Last Name</label>
            <i class="fas fa-user-edit"></i>
            <input type="text" id="regLastName" name="regLastName" required>
          </div>
        </div>

        <div class="input-group">
          <label for="regEmail">Email Address</label>
          <i class="fas fa-envelope"></i>
          <input type="email" id="regEmail" name="regEmail" required>
        </div>
        
        <input type="button" value="Register Account" onclick="submitRegistration()">
      </form>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div id="changePasswordModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('changePasswordModal')">&times;</span>
      <h2>Change Password</h2>
      <form id="changePasswordForm">
        <label for="currentPassword">Current Password:</label><br>
        <input type="password" id="currentPassword" name="currentPassword" required><br><br>
        
        <label for="newPassword">New Password:</label><br>
        <input type="password" id="newPassword" name="newPassword" required><br><br>
        
        <label for="confirmPassword">Confirm New Password:</label><br>
        <input type="password" id="confirmPassword" name="confirmPassword" required><br><br>
        
        <input type="button" value="Change Password" onclick="submitPasswordChange()" class="submit-btn">
      </form>
    </div>
  </div>

  <!-- Setup Role Modal -->
  <div id="setupRoleModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('setupRoleModal')">&times;</span>
      <h2>Setup User Roles</h2>
      <div id="userRolesTable" class="user-roles-container">
        <!-- Table will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Landing Page Content -->
  <div id="landingPage">
    <div class="dashboard-header">
      <div class="user-info">
        <div class="project-title">
          <div class="title-with-logo">
            <img src="chslogo.png" alt="Culiat High School Logo">
            <h1>Culiatista Anecdotal Records</h1>
          </div>
        </div>
        <div class="welcome-section">
          <div class="user-avatar">
            <i class="fas fa-user-circle"></i>
          </div>
          <div class="user-details">
            <h3>Welcome back,</h3>
            <h2 id="userFullName"></h2>
            <span id="userName" style="display: none;"></span>
          </div>
        </div>
      </div>
      <div class="header-right">
        <div class="header-actions">
          <button class="change-password-btn" onclick="openSearchStudent()">
              <i class="fas fa-key"></i> Search Student
            </button>
          <button class="report-by-role-btn" onclick="showReportByRoleModal()">
            <i class="fas fa-chart-pie"></i> Report by Role
          </button>
          <button class="setup-role-btn" onclick="showSetupRoleModal()">
            <i class="fas fa-user-cog"></i> Setup Role
          </button>
          <button class="change-password-btn" onclick="showChangePasswordModal()">
            <i class="fas fa-key"></i> Change Password
          </button>
          <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
        <div class="date-time">
          <i class="far fa-calendar-alt"></i>
          <span id="currentDateTime"></span>
        </div>
      </div>
    </div>

    <!-- Action Buttons First -->
    <div class="main-actions">
      <button id="addReportBtn" class="main-action-btn" onclick="showAddReportModal()">
        <i class="fas fa-file-medical"></i>
        <span>Add Report</span>
      </button>
      
      <button id="viewReportBtn" class="main-action-btn" onclick="showViewRecordModal()">
        <i class="fas fa-folder-open"></i>
        <span>View Records</span>
      </button>
      
      <button id="addClinicReportBtn" class="main-action-btn" onclick="showAddClinicReportModal()">
        <i class="fas fa-notes-medical"></i>
        <span>Add Clinic Report</span>
      </button>
      
      <button id="viewClinicReportBtn" class="main-action-btn" onclick="showViewClinicRecordModal()">
        <i class="fas fa-hospital"></i>
        <span>View Clinic Records</span>
      </button>

      <button id="addCriticalBtn" class="main-action-btn" onclick="showAddCriticalModal()">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Add Critical Incident</span>
      </button>
      
      <button id="viewCriticalBtn" class="main-action-btn" onclick="showViewCriticalModal()">
        <i class="fas fa-search-plus"></i>
        <span>View Critical Incidents</span>
      </button>
    </div>

    <!-- Stats Cards Next -->
    <div class="dashboard-stats">
      <div class="stat-card">
        <i class="fas fa-file-alt"></i>
        <div class="stat-info">
          <h3>Total Reports</h3>
          <p id="totalReports">0</p>
        </div>
      </div>
      <div class="stat-card">
        <i class="fas fa-clinic-medical"></i>
        <div class="stat-info">
          <h3>Clinic Reports</h3>
          <p id="totalClinicReports">0</p>
        </div>
      </div>
      <div class="stat-card">
        <i class="fas fa-exclamation-triangle"></i>
        <div class="stat-info">
          <h3>Critical Incidents</h3>
          <p id="totalCriticalReports">0</p>
        </div>
      </div>
      <div class="stat-card" id="todayReportsCard">
        <i class="fas fa-calendar-day"></i>
        <div class="stat-info">
          <h3>Today's Reports</h3>
          <p id="todayReports">0</p>
          <div class="tooltip">
            <div class="tooltip-content">
              <p>Reports: <span id="todayRegularReports">0</span></p>
              <p>Clinic Reports: <span id="todayClinicReportsCount">0</span></p>
              <p>Critical Incidents: <span id="todayCriticalReportsCount">0</span></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="instructions">
      <h3><i class="fas fa-info-circle"></i> Quick Guide</h3>
      <div class="instruction-grid">
        <div class="instruction-card">
          <i class="fas fa-file-alt"></i>
          <h4>Create Reports</h4>
          <p>Add detailed student reports with all necessary information</p>
        </div>
        <div class="instruction-card">
          <i class="fas fa-search"></i>
          <h4>Search Records</h4>
          <p>Find and manage existing records easily</p>
        </div>
        <div class="instruction-card">
          <i class="fas fa-hospital-user"></i>
          <h4>Clinic Records</h4>
          <p>Manage health-related records and visits</p>
        </div>
        <div class="instruction-card">
          <i class="fas fa-clock"></i>
          <h4>Real-time Updates</h4>
          <p>All changes are saved instantly</p>
        </div>
      </div>
    </div>

    <!-- Add this before the closing landingPage div -->
    <div class="footer-note">
      <span>Created by: Cerille Josep M. Reyes & Ma. Esperanza S. Ventura</span>
    </div>
  </div> <!-- closing landingPage div -->
    
     <!-- Add Report Modal -->
    <div id="addReportModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('addReportModal')">&times;</span>
        <h2>Add Report</h2>
        <form id="reportForm">
          <div class="form-section student-info">
            <h3>Student Information</h3>
            <div class="input-group">
              <label for="studentNumber" class="required-field">Student Number</label>
              <input type="text" id="studentNumber" name="studentNumber" required>
            </div>
            <div class="input-group">
              <label for="gradeLevel" class="required-field">Grade Level</label>
              <select id="gradeLevel" name="gradeLevel" required>
                <option value="">Select Grade Level</option>
              </select>
            </div>
            <div class="input-group">
              <label for="section" class="required-field">Section</label>
              <input type="text" id="section" name="section" required>
            </div>
            <div class="input-group">
              <label for="firstName" class="required-field">First Name</label>
              <input type="text" id="firstName" name="firstName" required>
            </div>
            <div class="input-group">
              <label for="lastName" class="required-field">Last Name</label>
              <input type="text" id="lastName" name="lastName" required>
            </div>
            <div class="input-group">
              <label for="suffix">Suffix</label>
              <input type="text" id="suffix" name="suffix">
            </div>
          </div>

          <div class="form-section">
            <h3>Report Details</h3>
            <div class="input-group">
              <label for="issuesConcern" class="required-field">Issues and Concern</label>
              <textarea id="issuesConcern" name="issuesConcern" required></textarea>
            </div>
          </div>

          <div class="form-section full-width">
            <div class="input-group">
              <label for="description" class="required-field">Description</label>
              <textarea id="description" name="description" required></textarea>
            </div>
            <div class="input-group">
              <label for="actionTaken" class="required-field">Action Taken</label>
              <textarea id="actionTaken" name="actionTaken" required></textarea>
            </div>
            <div class="input-group">
              <label for="recommendation" class="required-field">Recommendation</label>
              <textarea id="recommendation" name="recommendation" required></textarea>
            </div>
          </div>

          <input type="hidden" id="reportedBy" name="reportedBy">
          <input type="hidden" id="userRole" name="userRole">

          <div class="form-actions">
            <button type="button" class="cancel-btn" onclick="closeModal('addReportModal')">Cancel</button>
            <button type="button" class="submit-btn" onclick="submitReport()">Submit Report</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add Clinic Report Modal -->
<div id="addClinicReportModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('addClinicReportModal')">&times;</span>
    <h2>Add Clinic Report</h2>
    <form id="clinicReportForm">
          <div class="form-section student-info">
            <h3>Student Information</h3>
            <div class="input-group">
              <label for="clinicStudentNumber" class="required-field">Student Number</label>
              <input type="text" id="clinicStudentNumber" name="clinicStudentNumber" required>
            </div>
            <div class="input-group">
              <label for="clinicGradeLevel" class="required-field">Grade Level</label>
      <select id="clinicGradeLevel" name="clinicGradeLevel" required>
          <option value="">Select Grade Level</option>
          <option value="Grade 7">Grade 7</option>
          <option value="Grade 8">Grade 8</option>
          <option value="Grade 9">Grade 9</option>
          <option value="Grade 10">Grade 10</option>
          <option value="Grade 11">Grade 11</option>
          <option value="Grade 12">Grade 12</option>
              </select>
            </div>
            <div class="input-group">
              <label for="clinicSection" class="required-field">Section</label>
              <input type="text" id="clinicSection" name="clinicSection" required>
            </div>
            <div class="input-group">
              <label for="clinicFirstName" class="required-field">First Name</label>
              <input type="text" id="clinicFirstName" name="clinicFirstName" required>
            </div>
            <div class="input-group">
              <label for="clinicLastName" class="required-field">Last Name</label>
              <input type="text" id="clinicLastName" name="clinicLastName" required>
            </div>
            <div class="input-group">
              <label for="clinicSuffix">Suffix</label>
              <input type="text" id="clinicSuffix" name="clinicSuffix">
            </div>
          </div>

          <div class="form-section">
            <h3>Clinic Report Details</h3>
            <div class="input-group">
              <label for="clinicIssuesConcern" class="required-field">Issues and Concern</label>
              <textarea id="clinicIssuesConcern" name="clinicIssuesConcern" required></textarea>
            </div>
          </div>

          <div class="form-section full-width">
            <div class="input-group">
              <label for="clinicDescription" class="required-field">Description</label>
              <textarea id="clinicDescription" name="clinicDescription" required></textarea>
            </div>
            <div class="input-group">
              <label for="clinicActionTaken" class="required-field">Action Taken</label>
              <textarea id="clinicActionTaken" name="clinicActionTaken" required></textarea>
            </div>
            <div class="input-group">
              <label for="clinicRecommendation" class="required-field">Recommendation</label>
              <textarea id="clinicRecommendation" name="clinicRecommendation" required></textarea>
            </div>
          </div>

      <input type="hidden" id="clinicReportedBy" name="clinicReportedBy">
      
          <div class="form-actions">
            <button type="button" class="cancel-btn" onclick="closeModal('addClinicReportModal')">Cancel</button>
            <button type="button" class="submit-btn" onclick="submitClinicReport()">Submit Clinic Report</button>
          </div>
    </form>
  </div>
</div>

    <!-- View Record Modal -->
    <div id="viewRecordModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('viewRecordModal')">&times;</span>
        <h2>View Record</h2>
      
      <!-- Search and Filter Section -->
      <div class="search-filter-container">
        <!-- Date Filter -->
        <div class="date-filter">
          <div class="date-inputs">
            <div class="date-field">
              <label for="startDate">From:</label>
              <input type="date" id="startDate" name="startDate">
            </div>
            <div class="date-field">
              <label for="endDate">To:</label>
              <input type="date" id="endDate" name="endDate">
            </div>
          </div>
        </div>
        
        <!-- Search Input -->
        <div class="search-container">
          <input type="text" id="searchQuery" placeholder="Search by student number or name...">
          <button onclick="searchRecords()" class="filter-btn">
            <i class="fas fa-search"></i> Search
          </button>
        </div>
      </div>

      <!-- Records Display -->
        <div id="recordDetails" class="record-container"></div>
        <div class="navigation-buttons">
          <button id="prevButton" onclick="navigateRecord(-1)">Previous</button>
          <button id="nextButton" onclick="navigateRecord(1)">Next</button>
        </div>
        <div id="recordIndicator" class="record-indicator"></div>
    </div>
  </div>
  
  <!-- View Clinic Record Modal -->
<div id="viewClinicRecordModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('viewClinicRecordModal')">&times;</span>
    <h2>View Clinic Records</h2>
      
      <!-- Search and Filter Section -->
      <div class="search-filter-container">
        <!-- Date Filter -->
        <div class="date-filter">
          <div class="date-inputs">
            <div class="date-field">
              <label for="clinicStartDate">From:</label>
              <input type="date" id="clinicStartDate" name="clinicStartDate">
            </div>
            <div class="date-field">
              <label for="clinicEndDate">To:</label>
              <input type="date" id="clinicEndDate" name="clinicEndDate">
            </div>
          </div>
        </div>
        
        <!-- Search Input -->
        <div class="search-container">
          <input type="text" id="clinicSearchQuery" placeholder="Search by student number or name...">
          <button onclick="searchClinicRecords()" class="filter-btn">
            <i class="fas fa-search"></i> Search
          </button>
        </div>
      </div>

      <!-- Records Display -->
    <div id="clinicRecordDetails" class="record-container"></div>
    <div class="navigation-buttons">
      <button id="clinicPrevButton" onclick="navigateClinicRecord(-1)">Previous</button>
      <button id="clinicNextButton" onclick="navigateClinicRecord(1)">Next</button>
    </div>
    <div id="clinicRecordIndicator" class="record-indicator"></div>
  </div>
</div>

  <!-- Search Student Modal -->
  <div id="searchStudentModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('searchStudentModal')">&times;</span>
      <h2>Search Student</h2>
      <div class="search-container">
        <input type="text" id="studentSearchQuery" placeholder="Enter keywords to search...">
        <button onclick="searchStudentRecords()" class="filter-btn">Search</button>
      </div>
      <div id="studentSearchResults" class="record-container"></div>
    </div>
  </div>

  <script>

    //clinic grade level sections
    const gradeLevelSelect = document.getElementById('clinicGradeLevel');
    const sectionSelect = document.getElementById('clinicSection');

    // Define sections for each grade
    const sections = {
        "Grade 7": ["G7 - A"],
        "Grade 8": ["G8 - A", "G8 - B", "G8 - C"],
        "Grade 9": ["G9 - A", "G9 - B", "G9 - C"],
        "Grade 10": ["G10 - A", "G10 - B", "G10 - C"],
        "Grade 11": ["G11 - A", "G11 - B"],
        "Grade 12": ["G12 - A", "G12 - B"]
    };

    // Event listener for grade level selection
    gradeLevelSelect.addEventListener('change', function() {
        const selectedGrade = this.value;

        // Clear previous options
        sectionSelect.innerHTML = '<option value="">Select Section</option>';
        
        // Populate section dropdown based on selected grade
        if (selectedGrade && sections[selectedGrade]) {
            sections[selectedGrade].forEach(function(section) {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionSelect.appendChild(option);
            });
        }
    });
    //end of clinic grade level sections


    var records = []; // Global variable to store search results
    var currentIndex = 0; // Index to track the current record being displayed
    var userRole = ''; // Global variable to store the user role

    var clinicRecords = []; // Global variable to store clinic search results
    var clinicCurrentIndex = 0; // Index to track the current clinic record being displayed

    // Login function
    function login() {
        // Show loading state immediately
        Swal.fire({
            title: 'Logging in',
            html: 'Please wait...',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

      var username = document.getElementById('username').value;
      var password = document.getElementById('password').value;

        google.script.run
            .withSuccessHandler(function(result) {
                if (result.success) {
                    // Hide login form first
          document.getElementById('loginForm').style.display = 'none';
                    
                    // Set user information
                    userRole = result.role;
                    document.getElementById('userName').textContent = result.username;
                    const fullName = `${result.firstName || ''} ${result.lastName || ''}`.trim();
                    document.getElementById('userFullName').textContent = fullName || result.username;
                    
                    // Show landing page with opacity 0
                    const landingPage = document.getElementById('landingPage');
                    landingPage.style.opacity = '0';
                    landingPage.style.display = 'block';
                    
                    // Add dashboard-active class
                    document.body.classList.add('dashboard-active');
                    
                    // Force browser reflow
                    void landingPage.offsetWidth;
                    
                    // Fade in landing page
                    landingPage.style.opacity = '1';
                    
                    // Update button visibility
                    updateButtonVisibility(result.role);
                    
                    // Update dashboard stats
                    updateDashboardStats();
                    
                    // Start updating date and time
                    updateDateTime();
                    setInterval(updateDateTime, 1000);
                    
                    // Close loading state
                    Swal.close();
        } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Login Failed',
                        text: result.message || 'Invalid username or password',
                        confirmButtonColor: '#2193b0'
                    });
                }
            })
            .withFailureHandler(function(error) {
                Swal.fire({
                    icon: 'error',
                    title: 'System Error',
                    text: 'An error occurred during login. Please try again.',
                    confirmButtonColor: '#2193b0'
                });
            })
            .checkLogin(username, password);
    }

    // Load grade levels into dropdown
    function loadGradeLevels() {
      google.script.run.withSuccessHandler(function(data) {
        var gradeLevelSelect = document.getElementById('gradeLevel');
        gradeLevelSelect.innerHTML = '';
        data.forEach(function(level) {
          var option = document.createElement('option');
          option.value = level;
          option.textContent = level;
          gradeLevelSelect.appendChild(option);
        });
      }).getGradeLevels();
    }

    // Load sections based on selected grade level
    function loadSections() {
      var gradeLevel = document.getElementById('gradeLevel').value;
      google.script.run.withSuccessHandler(function(data) {
        var sectionSelect = document.getElementById('section');
        sectionSelect.innerHTML = '';
        data.forEach(function(section) {
          var option = document.createElement('option');
          option.value = section;
          option.textContent = section;
          sectionSelect.appendChild(option);
        });
      }).getSections(gradeLevel);
    }

    // Submit report form
    function submitReport() {
      // Get all required fields
      const requiredFields = [
        { id: 'studentNumber', label: 'Student Number' },
        { id: 'gradeLevel', label: 'Grade Level' },
        { id: 'section', label: 'Section' },
        { id: 'firstName', label: 'First Name' },
        { id: 'lastName', label: 'Last Name' },
        { id: 'issuesConcern', label: 'Issues and Concern' },
        { id: 'description', label: 'Description' },
        { id: 'actionTaken', label: 'Action Taken' },
        { id: 'recommendation', label: 'Recommendation' }
      ];

      // Check if all required fields are filled
      for (const field of requiredFields) {
        const value = document.getElementById(field.id).value.trim();
        if (!value) {
          Swal.fire({
            icon: 'warning',
            title: 'Required Field Empty',
            text: `Please fill in the ${field.label} field`,
            confirmButtonColor: '#2193b0'
          });
          return;
        }
      }

      // Show loading state
      Swal.fire({
        title: 'Submitting Report',
        html: `
          <div class="login-progress">
            <i class="fas fa-file-alt" style="color: #2193b0; font-size: 50px; margin-bottom: 20px;"></i>
            <p style="margin: 10px 0;">Saving your report...</p>
          </div>
        `,
        allowOutsideClick: false,
        showConfirmButton: false,
        willOpen: () => {
          Swal.showLoading();
        }
      });

      var reportData = {
        studentNumber: document.getElementById('studentNumber').value,
        gradeLevel: document.getElementById('gradeLevel').value,
        section: document.getElementById('section').value,
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        suffix: document.getElementById('suffix').value,
        issuesConcern: document.getElementById('issuesConcern').value,
        description: document.getElementById('description').value,
        actionTaken: document.getElementById('actionTaken').value,
        recommendation: document.getElementById('recommendation').value,
        reportedBy: document.getElementById('reportedBy').value,
        reportDate: new Date().toISOString(),
        role: userRole
      };

      google.script.run
        .withSuccessHandler(function() {
        Swal.fire({
          icon: 'success',
            title: 'Success!',
            text: 'Your report has been successfully submitted',
            confirmButtonColor: '#2193b0',
            timer: 2000,
            timerProgressBar: true
        }).then(() => {
          document.getElementById('reportForm').reset();
          closeModal('addReportModal');
            updateDashboardStats();
          });
        })
        .withFailureHandler(function(error) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to submit report. Please try again.',
            confirmButtonColor: '#2193b0'
          });
        })
        .saveReport(reportData);
    }

    // Show modal
    function showAddReportModal() {
      document.getElementById('addReportModal').style.display = 'block';
      document.getElementById('userRole').value = userRole; // Set user role in the hidden field
      document.getElementById('reportedBy').value = document.getElementById('userName').textContent; // Set reported by field
      populateGradeLevels(); // Add this line
    }

    function showViewRecordModal() {
      document.getElementById('viewRecordModal').style.display = 'block';
    }

    // Close modal
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    // Search records
    function searchRecords() {
      var query = document.getElementById('searchQuery').value; // Changed from 'searchInput' to 'searchQuery'
      var startDate = document.getElementById('startDate').value;
      var endDate = document.getElementById('endDate').value;
      
      // Show loading
      Swal.fire({
        title: 'Searching Records',
        text: 'Please wait...',
        allowOutsideClick: false,
        showConfirmButton: false,
        willOpen: () => {
          Swal.showLoading();
        }
      });

      google.script.run
        .withSuccessHandler(function(results) {
          Swal.close();
          records = results;
          currentIndex = 0;
          
          if (records.length > 0) {
            displayRecord(0);
          } else {
            document.getElementById('recordDetails').innerHTML = '<p>No records found.</p>';
            disableNavigation();
          }
        })
        .withFailureHandler(function(error) {
          Swal.close();
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to search records. Please try again.'
          });
        })
        .searchReports(query, startDate, endDate);
    }

    // Display record details
    function displayRecord(index) {
      var recordDetails = document.getElementById('recordDetails');
      recordDetails.innerHTML = '';

      if (records.length === 0) {
        recordDetails.innerHTML = '<div class="no-records">No records found.</div>';
        document.getElementById('recordIndicator').textContent = '';
        disableNavigation();
        return;
      }

      var record = records[index];
      // Format the date nicely
      const recordDate = new Date(record[11]);
      const formattedDate = recordDate.toLocaleString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      var detailsHTML = `
        <div class="record-card">
          <div class="record-row">
            <div class="record-field"><strong>Student Number:</strong> ${record[0]}</div>
            <div class="record-field"><strong>Grade Level:</strong> ${record[1]}</div>
            <div class="record-field"><strong>Section:</strong> ${record[2]}</div>
          </div>

          <div class="record-row">
            <div class="record-field"><strong>First Name:</strong> ${record[3]}</div>
            <div class="record-field"><strong>Last Name:</strong> ${record[4]}</div>
            <div class="record-field"><strong>Suffix:</strong> ${record[5] || '-'}</div>
          </div>

          <div class="record-row full-width">
            <div class="record-field"><strong>Issues and Concern:</strong><br>${record[6]}</div>
          </div>

          <div class="record-row full-width">
            <div class="record-field"><strong>Description:</strong><br>${record[7]}</div>
          </div>

          <div class="record-row full-width">
            <div class="record-field"><strong>Action Taken:</strong><br>${record[8]}</div>
          </div>

          <div class="record-row full-width">
            <div class="record-field"><strong>Recommendation:</strong><br>${record[9]}</div>
          </div>

          <div class="record-row footer">
            <div class="record-field"><strong>Reported By:</strong> ${record[10]}</div>
            <div class="record-field"><strong>Date:</strong> ${formattedDate}</div>
          </div>
        </div>
      `;

      recordDetails.innerHTML = detailsHTML;
      document.getElementById('recordIndicator').textContent = `Record ${index + 1} of ${records.length}`;
      document.getElementById('prevButton').disabled = (index === 0);
      document.getElementById('nextButton').disabled = (index === records.length - 1);
    }

    // Navigate between records
    function navigateRecord(direction) {
      var newIndex = currentIndex + direction;
      if (newIndex >= 0 && newIndex < records.length) {
        currentIndex = newIndex;
        displayRecord(currentIndex);
      }
    }

    // Disable navigation buttons
    function disableNavigation() {
      document.getElementById('prevButton').disabled = true;
      document.getElementById('nextButton').disabled = true;
    }
    // end of Add Report Records

    // Logout function
    function logout() {
      // Show confirmation dialog
      Swal.fire({
        title: 'Logout',
        text: 'Are you sure you want to logout?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, logout',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          // Show loading overlay
          const loadingOverlay = document.getElementById('loadingOverlay');
          loadingOverlay.style.display = 'flex';
          loadingOverlay.style.opacity = '1';

          // Fade out dashboard
          document.getElementById('landingPage').style.opacity = '0';
          
          setTimeout(() => {
            // Hide dashboard
      document.getElementById('landingPage').style.display = 'none';
            
            // Reset user info
            document.getElementById('userName').textContent = '';
            document.getElementById('userFullName').textContent = '';
            userRole = '';
            
            // Show and fade in login form
            const loginForm = document.getElementById('loginForm');
            loginForm.style.display = 'block';
            loginForm.style.opacity = '0';
            
            // Clear login form fields
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            // Remove dashboard active class
            document.body.classList.remove('dashboard-active');
            
            // Hide loading overlay
            loadingOverlay.style.opacity = '0';
            setTimeout(() => {
              loadingOverlay.style.display = 'none';
              loginForm.style.opacity = '1';
            }, 300);
          }, 300);
        }
      });
    }

// Show modal for adding a clinic report
function showAddClinicReportModal() {
  document.getElementById('addClinicReportModal').style.display = 'block';
  document.getElementById('clinicReportedBy').value = document.getElementById('userName').textContent;
  populateGradeLevels(); // Add this line to populate grade levels
}
// Submit clinic report form
function submitClinicReport() {
  // Get all required fields
  const requiredFields = [
    { id: 'clinicStudentNumber', label: 'Student Number' },
    { id: 'clinicGradeLevel', label: 'Grade Level' },
    { id: 'clinicSection', label: 'Section' },
    { id: 'clinicFirstName', label: 'First Name' },
    { id: 'clinicLastName', label: 'Last Name' },
    { id: 'clinicIssuesConcern', label: 'Issues and Concern' },
    { id: 'clinicDescription', label: 'Description' },
    { id: 'clinicActionTaken', label: 'Action Taken' },
    { id: 'clinicRecommendation', label: 'Recommendation' }
  ];

  // Check if all required fields are filled
  for (const field of requiredFields) {
    const value = document.getElementById(field.id).value.trim();
    if (!value) {
      Swal.fire({
        icon: 'warning',
        title: 'Required Field Empty',
        text: `Please fill in the ${field.label} field`,
        confirmButtonColor: '#2193b0'
      });
      return;
    }
  }

  // Show loading state
  Swal.fire({
    title: 'Submitting Clinic Report',
    html: `
      <div class="login-progress">
        <i class="fas fa-hospital" style="color: #2193b0; font-size: 50px; margin-bottom: 20px;"></i>
        <p style="margin: 10px 0;">Saving your clinic report...</p>
      </div>
    `,
    allowOutsideClick: false,
    showConfirmButton: false,
    willOpen: () => {
      Swal.showLoading();
    }
  });

  var clinicReportData = {
    studentNumber: document.getElementById('clinicStudentNumber').value,
    gradeLevel: document.getElementById('clinicGradeLevel').value,
    section: document.getElementById('clinicSection').value,
    firstName: document.getElementById('clinicFirstName').value,
    lastName: document.getElementById('clinicLastName').value,
    suffix: document.getElementById('clinicSuffix').value,
    issuesConcern: document.getElementById('clinicIssuesConcern').value,
    description: document.getElementById('clinicDescription').value,
    actionTaken: document.getElementById('clinicActionTaken').value,
    recommendation: document.getElementById('clinicRecommendation').value,
    reportedBy: document.getElementById('clinicReportedBy').value,
    reportDate: new Date().toISOString(),
    role: userRole
  };

  google.script.run
    .withSuccessHandler(function() {
    Swal.fire({
      icon: 'success',
        title: 'Success!',
        text: 'Your clinic report has been successfully submitted',
        confirmButtonColor: '#2193b0',
        timer: 2000,
        timerProgressBar: true
    }).then(() => {
      document.getElementById('clinicReportForm').reset();
      closeModal('addClinicReportModal');
        updateDashboardStats();
      });
    })
    .withFailureHandler(function(error) {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Failed to submit clinic report. Please try again.',
        confirmButtonColor: '#2193b0'
      });
    })
    .saveClinicReport(clinicReportData);
}

//clinicviewrecord

function showViewClinicRecordModal() {
  document.getElementById('viewClinicRecordModal').style.display = 'block';
}

function searchClinicRecords() {
  var query = document.getElementById('clinicSearchQuery').value;
    var startDate = document.getElementById('clinicStartDate').value;
    var endDate = document.getElementById('clinicEndDate').value;
    
    // Show loading
    Swal.fire({
        title: 'Searching Clinic Records',
        text: 'Please wait...',
        allowOutsideClick: false,
        showConfirmButton: false,
        willOpen: () => {
            Swal.showLoading();
        }
    });

    google.script.run
        .withSuccessHandler(function(results) {
            Swal.close();
            clinicRecords = results;
            clinicCurrentIndex = 0;
            
            if (clinicRecords.length > 0) {
                displayClinicRecord(0);
            } else {
                document.getElementById('clinicRecordDetails').innerHTML = '<div class="no-records">No records found.</div>';
                disableClinicNavigation();
            }
        })
        .withFailureHandler(function(error) {
            Swal.close();
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to search clinic records. Please try again.'
            });
        })
        .searchClinicReports(query, startDate, endDate);
}

// Update the displayClinicRecord function
function displayClinicRecord(index) {
    var recordDetails = document.getElementById('clinicRecordDetails');
    recordDetails.innerHTML = '';

  if (clinicRecords.length === 0) {
        recordDetails.innerHTML = '<div class="no-records">No records found.</div>';
    document.getElementById('clinicRecordIndicator').textContent = '';
    disableClinicNavigation();
    return;
  }

    var record = clinicRecords[index];
    const recordDate = new Date(record[11]);
    const formattedDate = recordDate.toLocaleString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });

  var detailsHTML = `
        <div class="record-card">
            <div class="record-row">
                <div class="record-field"><strong>Student Number:</strong> ${record[0]}</div>
                <div class="record-field"><strong>Grade Level:</strong> ${record[1]}</div>
                <div class="record-field"><strong>Section:</strong> ${record[2]}</div>
            </div>

            <div class="record-row">
                <div class="record-field"><strong>First Name:</strong> ${record[3]}</div>
                <div class="record-field"><strong>Last Name:</strong> ${record[4]}</div>
                <div class="record-field"><strong>Suffix:</strong> ${record[5] || '-'}</div>
            </div>

            <div class="record-row full-width">
                <div class="record-field"><strong>Issues and Concern:</strong><br>${record[6]}</div>
            </div>

            <div class="record-row full-width">
                <div class="record-field"><strong>Description:</strong><br>${record[7]}</div>
            </div>

            <div class="record-row full-width">
                <div class="record-field"><strong>Action Taken:</strong><br>${record[8]}</div>
            </div>

            <div class="record-row full-width">
                <div class="record-field"><strong>Recommendation:</strong><br>${record[9]}</div>
            </div>

            <div class="record-row footer">
                <div class="record-field"><strong>Reported By:</strong> ${record[10]}</div>
                <div class="record-field"><strong>Date:</strong> ${formattedDate}</div>
            </div>
        </div>
    `;

    recordDetails.innerHTML = detailsHTML;
  document.getElementById('clinicRecordIndicator').textContent = `Record ${index + 1} of ${clinicRecords.length}`;
  document.getElementById('clinicPrevButton').disabled = (index === 0);
  document.getElementById('clinicNextButton').disabled = (index === clinicRecords.length - 1);
}

function navigateClinicRecord(direction) {
  var newIndex = clinicCurrentIndex + direction;
  if (newIndex >= 0 && newIndex < clinicRecords.length) {
    clinicCurrentIndex = newIndex;
    displayClinicRecord(clinicCurrentIndex);
  }
}

function disableClinicNavigation() {
    document.getElementById('clinicPrevButton').disabled = true;
  document.getElementById('clinicNextButton').disabled = true;
}

  function showRegistrationModal() {
    // Show privacy agreement first
    document.getElementById('privacyAgreementModal').style.display = 'block';
  }

  function submitRegistration() {
    // Get form values
    const username = document.getElementById('regUsername').value.trim();
    const password = document.getElementById('regPassword').value.trim();
    const firstName = document.getElementById('regFirstName').value.trim();
    const lastName = document.getElementById('regLastName').value.trim();
    const email = document.getElementById('regEmail').value.trim();

    // Validate all fields are filled
    if (!username || !password || !firstName || !lastName || !email) {
      Swal.fire({
        icon: 'warning',
        title: 'Missing Information',
        text: 'Please fill in all required fields.',
        confirmButtonColor: '#2193b0'
      });
      return;
    }

    // Basic email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      Swal.fire({
        icon: 'error',
        title: 'Invalid Email',
        text: 'Please enter a valid email address.',
        confirmButtonColor: '#2193b0'
      });
      return;
    }

    // Show loading state
    Swal.fire({
      title: 'Creating Account',
      html: `
        <div class="login-progress">
          <i class="fas fa-user-plus" style="color: #2193b0; font-size: 50px; margin-bottom: 20px;"></i>
          <p style="margin: 10px 0;">Setting up your account...</p>
        </div>
      `,
      allowOutsideClick: false,
      showConfirmButton: false,
      willOpen: () => {
        Swal.showLoading();
      }
    });

    // Create user data object
    const userData = {
      username: username,
      password: password,
      firstName: firstName,
      lastName: lastName,
      email: email
    };

    // Call server-side function
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: result.message,
            confirmButtonColor: '#2193b0',
            timer: 2000,
            timerProgressBar: true
          }).then(() => {
            document.getElementById('registrationForm').reset();
            closeModal('registrationModal');
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Registration Failed',
            text: result.message,
            confirmButtonColor: '#2193b0'
          });
        }
      })
      .withFailureHandler(function(error) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to register: ' + error,
          confirmButtonColor: '#2193b0'
        });
      })
      .registerUser(userData);
  }

  // Function to update date and time
  function updateDateTime() {
    const now = new Date();
    const options = { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    };
    document.getElementById('currentDateTime').textContent = now.toLocaleDateString('en-US', options);
  }

  // Update date time every minute
  setInterval(updateDateTime, 60000);
  updateDateTime(); // Initial call

  // Function to update stats (call this after login and after adding new reports)
  function updateDashboardStats() {
    google.script.run
      .withSuccessHandler(function(stats) {
      document.getElementById('totalReports').textContent = stats.totalReports;
      document.getElementById('totalClinicReports').textContent = stats.totalClinicReports;
      document.getElementById('totalCriticalReports').textContent = stats.totalCriticalReports;
      document.getElementById('todayReports').textContent = stats.todayReports;
        
        // Update the tooltip counters
      document.getElementById('todayRegularReports').textContent = stats.todayReportsBreakdown.reports;
      document.getElementById('todayClinicReportsCount').textContent = stats.todayReportsBreakdown.clinicReports;
      document.getElementById('todayCriticalReportsCount').textContent = stats.todayReportsBreakdown.criticalReports;
      })
      .getDashboardStats();
  }

  // Add this to your login success handler
  // Inside your login success handler, add:
  updateDashboardStats();

  function showChangePasswordModal() {
    document.getElementById('changePasswordModal').style.display = 'block';
  }

  function submitPasswordChange() {
    var currentPassword = document.getElementById('currentPassword').value;
    var newPassword = document.getElementById('newPassword').value;
    var confirmPassword = document.getElementById('confirmPassword').value;
    var username = document.getElementById('userName').textContent;
    
    // Check if new passwords match
    if (newPassword !== confirmPassword) {
      Swal.fire({
        icon: 'error',
        title: 'Password Mismatch',
        text: 'New password and confirm password do not match.'
      });
      return;
    }

    // Show loading SweetAlert
    Swal.fire({
      title: 'Changing Password',
      text: 'Please wait...',
      allowOutsideClick: false,
      allowEscapeKey: false,
      showConfirmButton: false,
      willOpen: () => {
        Swal.showLoading();
      }
    });
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          Swal.fire({
            icon: 'success',
            title: 'Success',
            text: 'Password changed successfully!'
          }).then(() => {
            document.getElementById('changePasswordForm').reset();
            closeModal('changePasswordModal');
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: result.message || 'Current password is incorrect.'
          });
        }
      })
      .withFailureHandler(function(error) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to change password. Please try again.'
        });
      })
      .changePassword(username, currentPassword, newPassword);
  }

  function showSetupRoleModal() {
    document.getElementById('setupRoleModal').style.display = 'block';
    loadUserRoles();
  }

  function loadUserRoles() {
    // Show loading state
    Swal.fire({
      title: 'Loading Users',
      html: 'Please wait...',
      allowOutsideClick: false,
      showConfirmButton: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    google.script.run
      .withSuccessHandler(function(users) {
        if (users && users.length > 0) {
          const container = document.getElementById('userRolesTable');
          let html = `
            <table class="user-roles-table">
              <thead>
                <tr>
                  <th>Username</th>
                  <th>Full Name</th>
                  <th>Current Role</th>
                  <th>New Role</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
          `;

          users.forEach(user => {
            const fullName = `${user.firstName} ${user.lastName}`.trim();
            const currentRole = user.role || 'No Role';
            
            html += `
              <tr>
                <td>${user.username}</td>
                <td>${fullName}</td>
                <td>${currentRole}</td>
                <td>
                  <select class="role-select" id="roleSelect_${user.username}">
                    <option value="">Select Role</option>
                    <option value="Admin" ${currentRole === 'Admin' ? 'selected' : ''}>Admin</option>
                    <option value="Head Teacher" ${currentRole === 'Head Teacher' ? 'selected' : ''}>Head Teacher</option>
                    <option value="Teacher" ${currentRole === 'Teacher' ? 'selected' : ''}>Teacher</option>
                    <option value="Librarian" ${currentRole === 'Librarian' ? 'selected' : ''}>Librarian</option>
                    <option value="Guidance" ${currentRole === 'Guidance' ? 'selected' : ''}>Guidance</option>
                    <option value="Clinic" ${currentRole === 'Clinic' ? 'selected' : ''}>Clinic</option>
                    <option value="Adviser" ${currentRole === 'Adviser' ? 'selected' : ''}>Adviser</option>
                  </select>
                </td>
                <td>
                  <button class="save-role-btn" onclick="updateUserRole('${user.username}')">
                    <i class="fas fa-save"></i> Save
                  </button>
                </td>
              </tr>
            `;
          });

          html += '</tbody></table>';
          container.innerHTML = html;
          Swal.close();
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No users found or failed to load users.',
          });
        }
      })
      .withFailureHandler(function(error) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to load users: ' + error,
        });
      })
      .getUserRoles();
  }

  function updateUserRole(username) {
    const select = document.getElementById(`roleSelect_${username}`);
    const newRole = select.value;
    
    if (!newRole) {
      Swal.fire({
        icon: 'warning',
        title: 'Warning',
        text: 'Please select a role first.'
      });
      return;
    }

    // Show loading state
    Swal.fire({
      title: 'Updating Role',
      html: 'Please wait...',
      allowOutsideClick: false,
      showConfirmButton: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          Swal.fire({
            icon: 'success',
            title: 'Success',
            text: 'User role updated successfully!'
          }).then(() => {
            loadUserRoles(); // Reload the table
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: result.message || 'Failed to update user role.'
          });
        }
      })
      .withFailureHandler(function(error) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to update user role: ' + error
        });
      })
      .updateUserRole(username, newRole);
  }

  function updateButtonVisibility(role) {
    // Hide all main action buttons if role is NoRole or empty
    const mainActions = document.querySelector('.main-actions');
    if (role === 'NoRole' || !role) {
        if (mainActions) mainActions.style.display = 'none';
    } else {
        if (mainActions) mainActions.style.display = 'grid';
    }

    const buttons = {
        'report-by-role-btn': ['Admin', 'Head Teacher'],
        'setup-role-btn': ['Admin'],
        'change-password-btn': ['Admin', 'Head Teacher', 'Teacher', 'Librarian', 'Guidance', 'Clinic', 'Adviser', 'NoRole', ''],
        'logout-btn': ['Admin', 'Head Teacher', 'Teacher', 'Librarian', 'Guidance', 'Clinic', 'Adviser', 'NoRole', ''],
        'addCriticalBtn': ['Admin', 'Head Teacher', 'Adviser', 'Guidance'],
        'viewCriticalBtn': ['Admin', 'Head Teacher', 'Guidance']
    };

    // Hide all buttons first
    Object.keys(buttons).forEach(btnClass => {
        const btn = document.querySelector(`.${btnClass}`);
        if (btn) {
            btn.style.display = 'none';
        }
    });

    // Show buttons based on role
    Object.entries(buttons).forEach(([btnClass, allowedRoles]) => {
        const btn = document.querySelector(`.${btnClass}`);
        if (btn && allowedRoles.includes(role)) {
            btn.style.display = 'flex';
        }
    });

    // Update other UI elements based on role
    updateUIForRole(role);
  }

  function updateUIForRole(role) {
    // Get all action buttons
    const addReportBtn = document.getElementById('addReportBtn');
    const viewReportBtn = document.getElementById('viewReportBtn');
    const addClinicReportBtn = document.getElementById('addClinicReportBtn');
    const viewClinicReportBtn = document.getElementById('viewClinicReportBtn');
    const addCriticalBtn = document.getElementById('addCriticalBtn');
    const viewCriticalBtn = document.getElementById('viewCriticalBtn');
    
    // Get critical incidents stat card
    const criticalStatsCard = document.querySelector('.stat-card:nth-child(3)'); // Critical incidents card
    const todayCriticalCount = document.querySelector('.tooltip-content p:nth-child(3)'); // Critical count in today's tooltip

    // Hide all buttons first
    if (addReportBtn) addReportBtn.style.display = 'none';
    if (viewReportBtn) addReportBtn.style.display = 'none';
    if (addClinicReportBtn) addClinicReportBtn.style.display = 'none';
    if (viewClinicReportBtn) viewClinicReportBtn.style.display = 'none';
    if (addCriticalBtn) addCriticalBtn.style.display = 'none';
    if (viewCriticalBtn) viewCriticalBtn.style.display = 'none';
    
    // Hide critical incidents stats by default
    if (criticalStatsCard) criticalStatsCard.style.display = 'none';
    if (todayCriticalCount) todayCriticalCount.style.display = 'none';

    // Show buttons and stats based on role
    switch(role) {
      case 'Admin':
      case 'Head Teacher':
        // Show all buttons and stats
        if (addReportBtn) addReportBtn.style.display = 'flex';
        if (viewReportBtn) viewReportBtn.style.display = 'flex';
        if (addClinicReportBtn) addClinicReportBtn.style.display = 'flex';
        if (viewClinicReportBtn) viewClinicReportBtn.style.display = 'flex';
        if (addCriticalBtn) addCriticalBtn.style.display = 'flex';
        if (viewCriticalBtn) viewCriticalBtn.style.display = 'flex';
        if (criticalStatsCard) criticalStatsCard.style.display = 'flex';
        if (todayCriticalCount) todayCriticalCount.style.display = 'block';
        break;

      case 'Guidance':
        // Regular reports, critical incidents buttons and stats
        if (addReportBtn) addReportBtn.style.display = 'flex';
        if (viewReportBtn) viewReportBtn.style.display = 'flex';
        if (addCriticalBtn) addCriticalBtn.style.display = 'flex';
        if (viewCriticalBtn) viewCriticalBtn.style.display = 'flex';
        if (criticalStatsCard) criticalStatsCard.style.display = 'flex';
        if (todayCriticalCount) todayCriticalCount.style.display = 'block';
        break;

      case 'Adviser':
        // Regular reports, view clinic records, and add critical incidents
        if (addReportBtn) addReportBtn.style.display = 'flex';
        if (viewReportBtn) viewReportBtn.style.display = 'flex';
        if (viewClinicReportBtn) viewClinicReportBtn.style.display = 'flex';
        if (addCriticalBtn) addCriticalBtn.style.display = 'flex';
        break;

      case 'Teacher':
      case 'Librarian':
        // Only regular reports
        if (addReportBtn) addReportBtn.style.display = 'flex';
        if (viewReportBtn) viewReportBtn.style.display = 'flex';
        break;

      case 'Clinic':
        // Only clinic reports
        if (addClinicReportBtn) addClinicReportBtn.style.display = 'flex';
        if (viewClinicReportBtn) viewClinicReportBtn.style.display = 'flex';
        break;
    }
  }

  // Replace the existing grade levels object with this:
  const gradeLevels = {
      "Grade 7": ["G7 - A"],
      "Grade 8": ["G8 - A", "G8 - B", "G8 - C"],
      "Grade 9": ["G9 - A", "G9 - B", "G9 - C"],
      "Grade 10": ["G10 - A", "G10 - B", "G10 - C"],
      "Grade 11": ["G11 - A", "G11 - B"],
      "Grade 12": ["G12 - A", "G12 - B"]
  };

  // Add this function to populate the grade level dropdown
  function populateGradeLevels() {
      const gradeLevelSelect = document.getElementById('gradeLevel');
      gradeLevelSelect.innerHTML = '<option value="">Select Grade Level</option>';
      Object.keys(gradeLevels).forEach(grade => {
          const option = document.createElement('option');
          option.value = grade;
          option.textContent = grade;
          gradeLevelSelect.appendChild(option);
      });
  }

  function searchClinicReports(query, startDate, endDate) {
    var sheet = SpreadsheetApp.openById('1OSLEmyrc8kCPjZ-3ao6wn1VkOVcdO_U6pShLnwdOoNtswbEQGGBzHk5c').getSheetByName('clinic_report');
    var data = sheet.getDataRange().getValues();
    var results = [];
    
    // Convert dates to comparable format
    var start = startDate ? new Date(startDate) : null;
    var end = endDate ? new Date(endDate) : null;
    start?.setHours(0,0,0,0);
    end?.setHours(23,59,59,999);
    
    // Skip header row
    for (var i = 1; i < data.length; i++) {
        var row = data[i];
        var rowDate = new Date(row[11]); // Assuming date is in column L (index 11)
        var matchesDate = true;
        
        if (start && end) {
            matchesDate = rowDate >= start && rowDate <= end;
        }
        
        var searchString = query.toLowerCase();
        var matchesSearch = row[0].toString().toLowerCase().includes(searchString) || // Student Number
                           row[3].toString().toLowerCase().includes(searchString) || // First Name
                           row[4].toString().toLowerCase().includes(searchString);   // Last Name
        
        if (matchesSearch && matchesDate) {
            results.push(row);
        }
    }
    
    return results;
}

    // ... existing code ...

    function loadDashboardStats(userRole) {
      // Show loading state
      const statsContainer = document.querySelector('.stats-container');
      if (statsContainer) {
        statsContainer.style.display = 'none';
      }
      
      const loadingDiv = document.getElementById('loadingOverlay');
      if (loadingDiv) {
        loadingDiv.style.display = 'flex';
      }

      google.script.run
        .withSuccessHandler(function(stats) {
          if (loadingDiv) {
            loadingDiv.style.display = 'none';
          }
          
          if (stats.error) {
            // If access is denied or there's an error, hide the stats container
            if (statsContainer) {
              statsContainer.style.display = 'none';
            }
            // Only show error message if it's not an access denied message
            if (!stats.error.includes('Access denied')) {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: stats.error
              });
            }
            return;
          }

          // Show stats container if user has access
          if (statsContainer) {
            statsContainer.style.display = 'grid';
          }

          // Update the statistics
          document.getElementById('totalReports').textContent = stats.totalReports;
          document.getElementById('totalClinicReports').textContent = stats.totalClinicReports;
          document.getElementById('totalCriticalReports').textContent = stats.totalCriticalReports;
          document.getElementById('todayReports').textContent = stats.todayReports;

          // Update tooltip content
          const tooltipContent = document.querySelector('.tooltip-content');
          if (tooltipContent) {
            tooltipContent.innerHTML = `
              <p>Regular Reports: ${stats.todayReportsBreakdown.reports}</p>
              <p>Clinic Reports: ${stats.todayReportsBreakdown.clinicReports}</p>
              <p>Critical Reports: ${stats.todayReportsBreakdown.criticalReports}</p>
            `;
          }
        })
        .withFailureHandler(function(error) {
          if (loadingDiv) {
            loadingDiv.style.display = 'none';
          }
          if (statsContainer) {
            statsContainer.style.display = 'none';
          }
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to load dashboard statistics: ' + error
          });
        })
        .getDashboardStats(userRole);
    }

    // Update the login success handler to pass the user role
    function handleLoginSuccess(response) {
      if (response.success) {
        // Store user info
        currentUser = {
          username: response.username,
          firstName: response.firstName,
          lastName: response.lastName,
          role: response.role
        };
        
        // Update UI based on role
        updateButtonVisibility(response.role);
        
        // Load dashboard stats with user role
        loadDashboardStats(response.role);
        
        // Hide login form and show main content
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        
        // Update welcome message
        const welcomeMessage = document.getElementById('welcomeMessage');
        if (welcomeMessage) {
          welcomeMessage.textContent = `Welcome, ${response.firstName} ${response.lastName}!`;
        }
        
        // Start clock update
        updateClock();
        clockInterval = setInterval(updateClock, 1000);
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Login Failed',
          text: response.message || 'Invalid username or password'
        });
      }
    }

    // ... existing code ...

    // Function to show the Search Student modal
    function openSearchStudent() {
      document.getElementById('searchStudentModal').style.display = 'block';
    }

    // Function to search student records
    function searchStudentRecords() {
      var query = document.getElementById('studentSearchQuery').value.trim();

      if (!query) {
        Swal.fire({
          icon: 'warning',
          title: 'Empty Search Query',
          text: 'Please enter a keyword to search.',
          confirmButtonColor: '#2193b0'
        });
        return;
      }

      // Show loading state
      Swal.fire({
        title: 'Searching Students',
        text: 'Please wait...',
        allowOutsideClick: false,
        showConfirmButton: false,
        willOpen: () => {
          Swal.showLoading();
        }
      });

      google.script.run
        .withSuccessHandler(function(results) {
          Swal.close();
          displayStudentSearchResults(results);
        })
        .withFailureHandler(function(error) {
          Swal.close();
          Swal.fire({
            icon: 'error',
            title: 'Search Failed',
            text: 'Failed to search student records. Please try again.',
            confirmButtonColor: '#2193b0'
          });
        })
        .searchStudentRecords(query);
    }

    // Function to display student search results
    function displayStudentSearchResults(results) {
      var resultsContainer = document.getElementById('studentSearchResults');
      resultsContainer.innerHTML = '';

      if (results.length === 0) {
        resultsContainer.innerHTML = '<div class="no-records">No records found.</div>';
        return;
      }

      var headerHTML = `
        <div class="record-row">
          <div class="record-field"><strong>Learners Reference Number</strong></div>
          <div class="record-field"><strong>Fullname</strong></div>
          <div class="record-field"><strong>Grade Level</strong></div>
          <div class="record-field"><strong>Section</strong></div>
        </div>
      `;
      resultsContainer.innerHTML += headerHTML;

      results.forEach(function(record) {
        var recordHTML = `
          <div class="record-row">
            <div class="record-field">${record[0]}</div>
            <div class="record-field">${record[1]}</div>
            <div class="record-field">${record[2]}</div>
            <div class="record-field">${record[3]}</div>
          </div>
        `;
        resultsContainer.innerHTML += recordHTML;
      });
    }

    // Close modal function
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

  </script>

  <!-- Add this script at the end of your body tag -->
  <script>
  // Add event listener for Enter key in login form
  document.addEventListener('DOMContentLoaded', function() {
    // Get the login form inputs
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginForm = document.querySelector('#loginForm form');

    // Function to handle Enter key
    function handleEnterKey(event) {
      if (event.key === 'Enter') {
        event.preventDefault(); // Prevent default form submission
        login(); // Call the login function
      }
    }

    // Add keypress event listeners to both inputs
    usernameInput.addEventListener('keypress', handleEnterKey);
    passwordInput.addEventListener('keypress', handleEnterKey);

    // Add form submit handler
    loginForm.addEventListener('submit', function(event) {
      event.preventDefault();
      login();
    });
  });
  </script>

  <!-- Forgot Password Modal -->
  <div id="forgotPasswordModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('forgotPasswordModal')">&times;</span>
      <div class="forgot-password-header">
        <i class="fas fa-lock-open" style="font-size: 40px; color: #2193b0; margin-bottom: 15px;"></i>
        <h2>Forgot Password</h2>
        <p class="subtitle">Enter your registered email address to receive your password</p>
      </div>
      <form id="forgotPasswordForm">
        <div class="input-group">
          <label for="recoveryEmail" class="required-field">Email Address</label>
          <div class="input-with-icon">
            <i class="fas fa-envelope"></i>
            <input type="email" id="recoveryEmail" name="recoveryEmail" placeholder="Enter your email" required>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="cancel-btn" onclick="closeModal('forgotPasswordModal')">Cancel</button>
          <button type="button" class="submit-btn" onclick="sendPasswordRecovery()">
            <i class="fas fa-paper-plane"></i> Send Password
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add these functions to your existing JavaScript -->
  <script>
  // Add these functions to your existing JavaScript
  function showForgotPasswordModal() {
    event.preventDefault();
    const modal = document.getElementById('forgotPasswordModal');
    modal.style.display = 'block';
    document.getElementById('recoveryEmail').focus();
  }

  function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    if (modalId === 'forgotPasswordModal') {
      document.getElementById('forgotPasswordForm').reset();
    }
  }

  // Close modal when clicking outside
  window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
      event.target.style.display = 'none';
      if (event.target.id === 'forgotPasswordModal') {
        document.getElementById('forgotPasswordForm').reset();
      }
    }
  }

  function sendPasswordRecovery() {
    var email = document.getElementById('recoveryEmail').value.trim();
    
    if (!email) {
      Swal.fire({
        icon: 'warning',
        title: 'Email Required',
        text: 'Please enter your registered email address',
        confirmButtonColor: '#2193b0'
      });
      return;
    }

    // Email validation regex
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      Swal.fire({
        icon: 'error',
        title: 'Invalid Email',
        text: 'Please enter a valid email address',
        confirmButtonColor: '#2193b0'
      });
      return;
    }

    // Show loading state
    Swal.fire({
      title: 'Sending Password',
      html: `
        <div class="login-progress">
          <i class="fas fa-envelope-open-text" style="color: #2193b0; font-size: 50px; margin-bottom: 20px;"></i>
          <div style="margin: 15px 0;">
            <p style="margin: 5px 0;">Locating your account...</p>
            <p style="margin: 5px 0; font-size: 14px; color: #666;">Please wait while we process your request</p>
          </div>
        </div>
      `,
      allowOutsideClick: false,
      showConfirmButton: false,
      willOpen: () => {
        Swal.showLoading();
      }
    });

    // Call server-side function
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          Swal.fire({
            icon: 'success',
            title: 'Password Sent!',
            html: `
              <div style="margin: 20px 0;">
                <i class="fas fa-check-circle" style="color: #28a745; font-size: 40px; margin-bottom: 15px;"></i>
                <p style="margin: 10px 0;">Your password has been sent to:</p>
                <p style="color: #2193b0; font-weight: 500;">${email}</p>
                <p style="margin: 10px 0; font-size: 14px; color: #666;">Please check your email inbox</p>
              </div>
            `,
            confirmButtonColor: '#2193b0'
          }).then(() => {
            document.getElementById('forgotPasswordForm').reset();
            closeModal('forgotPasswordModal');
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Email Not Found',
            text: 'We couldn\'t find an account with that email address',
            confirmButtonColor: '#2193b0'
          });
        }
      })
      .withFailureHandler(function(error) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to send password. Please try again.',
          confirmButtonColor: '#2193b0'
        });
      })
      .sendPasswordByEmail(email);
  }
  </script>

  <!-- Add Data Privacy Agreement Modal -->
  <div id="privacyAgreementModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('privacyAgreementModal')">&times;</span>
      <div class="privacy-header">
        <i class="fas fa-shield-alt" style="font-size: 40px; color: #2193b0; margin-bottom: 15px;"></i>
        <h2>Data Privacy Agreement</h2>
      </div>
      <div class="privacy-content">
        <div class="privacy-text">
          <h3>Data Privacy and Confidentiality Agreement</h3>
          <p>By proceeding with the registration, you agree to the following terms regarding student data privacy and confidentiality:</p>
          
          <ol>
            <li><strong>Data Confidentiality:</strong> You acknowledge that you will have access to sensitive and confidential student information through the Culiatista Anecdotal Records system.</li>
            
            <li><strong>Legal Compliance:</strong> You agree to comply with the Data Privacy Act of 2012 (RA 10173) and all applicable data protection laws and regulations.</li>
            
            <li><strong>Responsibility:</strong> You will be liable for maintaining the confidentiality and security of all student records you access or manage.</li>
            
            <li><strong>Usage Restrictions:</strong>
              <ul>
                <li>Access student records only for legitimate educational purposes</li>
                <li>Never share login credentials with others</li>
                <li>Never disclose student information to unauthorized parties</li>
                <li>Maintain confidentiality even after employment ends</li>
              </ul>
            </li>
            
            <li><strong>Security Measures:</strong> You commit to:
              <ul>
                <li>Log out when leaving the system unattended</li>
                <li>Report any security incidents or breaches immediately</li>
                <li>Never store student data on personal devices</li>
              </ul>
            </li>
          </ol>

          <p><strong>Declaration:</strong> I understand that any violation of this agreement may result in disciplinary action, legal consequences, and immediate revocation of access privileges.</p>
        </div>
        <div class="privacy-actions">
          <button type="button" class="cancel-btn" onclick="closeModal('privacyAgreementModal')">Decline</button>
          <button type="button" class="submit-btn" onclick="acceptPrivacyAgreement()">
            <i class="fas fa-check"></i> I Accept
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
  /* Privacy Agreement Modal Styles */
  .privacy-header {
    text-align: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e0e0e0;
  }

  .privacy-header h2 {
    color: #1e3c72;
    margin: 10px 0;
    font-size: 24px;
  }

  .privacy-content {
    max-height: 60vh;
    overflow-y: auto;
    padding-right: 15px;
  }

  .privacy-text {
    color: #444;
    font-size: 14px;
    line-height: 1.6;
  }

  .privacy-text h3 {
    color: #1e3c72;
    margin: 0 0 15px 0;
    font-size: 18px;
  }

  .privacy-text p {
    margin: 10px 0;
  }

  .privacy-text ol {
    padding-left: 20px;
    margin: 15px 0;
  }

  .privacy-text li {
    margin-bottom: 12px;
  }

  .privacy-text ul {
    padding-left: 20px;
    margin: 8px 0;
  }

  .privacy-text ul li {
    margin-bottom: 6px;
    list-style-type: disc;
  }

  .privacy-actions {
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    margin-top: 25px;
    padding-top: 20px;
    border-top: 2px solid #e0e0e0;
  }

  .privacy-actions button {
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .privacy-actions .submit-btn {
    background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
    color: white;
    border: none;
  }

  .privacy-actions .cancel-btn {
    background: #f8f9fa;
    color: #666;
    border: 1px solid #e0e0e0;
  }

  .privacy-actions button:hover {
    transform: translateY(-1px);
  }

  .privacy-actions .submit-btn:hover {
    background: linear-gradient(135deg, #1c7a94 0%, #5bb8d0 100%);
    box-shadow: 0 4px 12px rgba(33, 147, 176, 0.2);
  }

  .privacy-actions .cancel-btn:hover {
    background: #e9ecef;
  }

  @media (max-width: 768px) {
    .privacy-content {
      max-height: 70vh;
    }
    
    .privacy-actions {
      flex-direction: column;
    }
    
    .privacy-actions button {
      width: 100%;
    }
  }
  </style>

  <script>
  // Update the showRegistrationModal function
  function showRegistrationModal() {
    // Show privacy agreement first
    document.getElementById('privacyAgreementModal').style.display = 'block';
  }

  function acceptPrivacyAgreement() {
    // Close privacy agreement modal
    closeModal('privacyAgreementModal');
    
    // Show success message
    Swal.fire({
      icon: 'success',
      title: 'Agreement Accepted',
      text: 'Thank you for accepting the Data Privacy Agreement',
      timer: 2000,
      timerProgressBar: true,
      showConfirmButton: false
    }).then(() => {
      // Show registration form
      document.getElementById('registrationModal').style.display = 'block';
      // Clear any previous form data
      document.getElementById('registrationForm').reset();
    });
  }
  </script>

  <script>
  // Initialize landing page
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize landing page
    const landingPage = document.getElementById('landingPage');
    landingPage.style.display = 'none';
    landingPage.style.opacity = '0';
  });
  </script>

  <!-- Add Report by Role Modal -->
  <div id="reportByRoleModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Report by Role</h2>
        <span class="close" onclick="closeReportByRoleModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="tab-navigation">
          <button class="tab-btn active" onclick="switchTab('roleStats')">By Role</button>
          <button class="tab-btn" onclick="switchTab('userStats')">By User</button>
          <button class="tab-btn" onclick="switchTab('criticalSummary')">Critical Incidents Summary</button>
        </div>
        
        <div id="roleStats" class="tab-content active">
          <!-- Role statistics content -->
        </div>
        
        <div id="userStats" class="tab-content">
          <div class="search-bar">
            <input type="text" id="userStatsSearch" placeholder="Search by name..." oninput="filterUserStats()">
          </div>
          <div id="userStatsContent">
            <!-- User statistics content -->
          </div>
        </div>

        <div id="criticalSummary" class="tab-content">
          <div class="critical-summary-container">
            <!-- Critical incidents summary will be loaded here -->
          </div>
        </div>
        
        <div id="userReportsView" class="tab-content" style="display: none;">
          <div class="user-reports-header">
            <button class="back-btn" onclick="hideUserReports()">
              <i class="fas fa-arrow-left"></i> Back to Statistics
            </button>
            <h3 id="selectedUserName"></h3>
            <div class="report-type-toggle">
              <button class="toggle-btn active" onclick="switchReportType('regular')">Regular Reports</button>
              <button class="toggle-btn" onclick="switchReportType('clinic')">Clinic Reports</button>
            </div>
          </div>
          <div id="userReportsContent">
            <!-- User reports will be displayed here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  // ... existing code ...

  function viewUserReports(username, fullName) {
    // Show loading state
    Swal.fire({
      title: 'Loading Reports',
      html: 'Please wait...',
      allowOutsideClick: false,
      showConfirmButton: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    // Call server function to get user reports
    google.script.run
      .withSuccessHandler(function(result) {
        Swal.close();
        if (result) {
          // Update selected user name
          document.getElementById('selectedUserName').textContent = fullName + "'s Reports";
          
          // Hide stats views and show reports view
          document.getElementById('roleStats').style.display = 'none';
          document.getElementById('userStats').style.display = 'none';
          document.getElementById('userReportsView').style.display = 'block';
          
          // Store the reports data
          window.currentUserReports = result;
          
          // Show regular reports by default
          switchReportType('regular');
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to load reports. Please try again.',
          });
        }
      })
      .withFailureHandler(function(error) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to load reports: ' + error,
        });
      })
      .getUserReports(username);
  }

  function hideUserReports() {
    document.getElementById('userReportsView').style.display = 'none';
    document.getElementById('userStats').style.display = 'block';
  }

  function switchReportType(type) {
    // Update toggle buttons
    document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    if (!window.currentUserReports) return;
    
    const reports = type === 'regular' ? window.currentUserReports.regular : window.currentUserReports.clinic;
    const container = document.getElementById('userReportsContent');
    
    if (reports.length === 0) {
      container.innerHTML = '<p class="no-reports">No reports found.</p>';
      return;
    }
    
    let html = `
      <div class="records-table-container">
        <table class="records-table">
          <thead>
            <tr>
              <th>Student Number</th>
              <th>Student Name</th>
              <th>Grade Level</th>
              <th>Section</th>
              <th>Issues and Concern</th>
              <th>Description</th>
              <th>Action Taken</th>
              <th>Recommendation</th>
              <th>Date & Time</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    reports.forEach((report, index) => {
      const date = new Date(report[11]).toLocaleDateString();
      const time = new Date(report[11]).toLocaleTimeString();
      
      // Correctly map the student information
      const studentNumber = report[0];
      const firstName = report[3];
      const lastName = report[4];
      const suffix = report[5] || '';
      const gradeLevel = report[1];
      const section = report[2];
      const issuesConcern = report[6];
      const description = report[7];
      const actionTaken = report[8];
      const recommendation = report[9];
      
      const studentName = `${firstName} ${lastName}${suffix ? ' ' + suffix : ''}`;
      
      html += `
        <tr>
          <td>${studentNumber}</td>
          <td>${studentName}</td>
          <td>${gradeLevel}</td>
          <td>${section}</td>
          <td>${issuesConcern}</td>
          <td>${description}</td>
          <td>${actionTaken}</td>
          <td>${recommendation}</td>
          <td>${date} ${time}</td>
        </tr>
      `;
    });
    
    html += `
        </tbody>
      </table>
      </div>
      <div class="navigation-buttons">
        <button id="prevButton" onclick="navigateReports('prev')" disabled>
          <i class="fas fa-chevron-left"></i> Previous
        </button>
        <span id="pageInfo">Page 1 of 1</span>
        <button id="nextButton" onclick="navigateReports('next')" disabled>
          Next <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    `;
    
    container.innerHTML = html;
    
    // Initialize pagination
    window.currentPage = 1;
    window.reportsPerPage = 10;
    window.currentReportType = type;
    updatePagination();
  }

  function navigateReports(direction) {
    const reports = window.currentUserReports[window.currentReportType];
    const totalPages = Math.ceil(reports.length / window.reportsPerPage);
    
    if (direction === 'prev' && window.currentPage > 1) {
      window.currentPage--;
    } else if (direction === 'next' && window.currentPage < totalPages) {
      window.currentPage++;
    }
    
    updatePagination();
  }

  function updatePagination() {
    const reports = window.currentUserReports[window.currentReportType];
    const totalPages = Math.ceil(reports.length / window.reportsPerPage);
    const startIndex = (window.currentPage - 1) * window.reportsPerPage;
    const endIndex = Math.min(startIndex + window.reportsPerPage, reports.length);
    
    // Update page info
    document.getElementById('pageInfo').textContent = `Page ${window.currentPage} of ${totalPages}`;
    
    // Update navigation buttons
    document.getElementById('prevButton').disabled = window.currentPage === 1;
    document.getElementById('nextButton').disabled = window.currentPage === totalPages;
    
    // Update table rows
    const tbody = document.querySelector('.records-table tbody');
    let html = '';
    
    for (let i = startIndex; i < endIndex; i++) {
      const report = reports[i];
      const date = new Date(report[11]).toLocaleDateString();
      const time = new Date(report[11]).toLocaleTimeString();
      
      // Correctly map the student information
      const studentNumber = report[0];
      const firstName = report[3];
      const lastName = report[4];
      const suffix = report[5] || '';
      const gradeLevel = report[1];
      const section = report[2];
      const issuesConcern = report[6];
      const description = report[7];
      const actionTaken = report[8];
      const recommendation = report[9];
      
      const studentName = `${firstName} ${lastName}${suffix ? ' ' + suffix : ''}`;
      
      html += `
        <tr>
          <td>${studentNumber}</td>
          <td>${studentName}</td>
          <td>${gradeLevel}</td>
          <td>${section}</td>
          <td>${issuesConcern}</td>
          <td>${description}</td>
          <td>${actionTaken}</td>
          <td>${recommendation}</td>
          <td>${date} ${time}</td>
        </tr>
      `;
    }
    
    tbody.innerHTML = html;
  }

  // ... existing code ...
  </script>

  <script>
  // ... existing code ...

  function showReportByRoleModal() {
    document.getElementById('reportByRoleModal').style.display = 'block';
    loadReportStats();
  }

  function closeReportByRoleModal() {
    document.getElementById('reportByRoleModal').style.display = 'none';
  }

  function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(tab => {
      tab.style.display = 'none';
    });
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    document.getElementById(tabId).style.display = 'block';
    event.target.classList.add('active');
  }

  function loadReportStats() {
    Swal.fire({
      title: 'Loading Statistics',
      html: 'Please wait...',
      allowOutsideClick: false,
      showConfirmButton: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    // Load both report stats and critical incidents summary
    Promise.all([
      new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .getReportStats();
      }),
      new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .getCriticalIncidentsSummary();
      })
    ]).then(([reportStats, criticalSummary]) => {
      if (reportStats && criticalSummary) {
        displayRoleStats(reportStats.roleStats);
        displayUserStats(reportStats.userStats);
        displayCriticalSummary(criticalSummary);
        Swal.close();
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to load statistics. Please try again.',
        });
      }
    }).catch(error => {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Failed to load statistics: ' + error,
      });
    });
  }

  function displayRoleStats(roleStats) {
    var roleStatsDiv = document.getElementById('roleStats');
    var html = '<div class="role-stats-container">';
    
    // Define role icons and colors
    const roleIcons = {
      'Admin': 'fa-user-shield',
      'Teacher': 'fa-chalkboard-teacher',
      'Librarian': 'fa-book-reader',
      'Guidance': 'fa-user-graduate',
      'Clinic': 'fa-user-md',
      'Adviser': 'fa-user-tie'
    };
    
    for (var role in roleStats) {
      var stats = roleStats[role];
      var total = stats.regular + stats.clinic + stats.critical;
      var icon = roleIcons[role] || 'fa-user';
      
      html += `
        <div class="role-stat-card">
          <div class="role-header">
            <i class="fas ${icon}"></i>
            <h3>${role}</h3>
          </div>
          <div class="stat-details">
            <div class="stat-item">
              <span class="stat-label">Regular Reports:</span>
              <span class="stat-value">${stats.regular}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Clinic Reports:</span>
              <span class="stat-value">${stats.clinic}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Critical Incidents:</span>
              <span class="stat-value">${stats.critical}</span>
            </div>
            <div class="stat-item total">
              <span class="stat-label">Total Reports:</span>
              <span class="stat-value">${total}</span>
            </div>
          </div>
        </div>
      `;
    }
    
    html += '</div>';
    roleStatsDiv.innerHTML = html;
  }

  function displayUserStats(userStats) {
    var userStatsContent = document.getElementById('userStatsContent');
    var html = `
      <table class="user-stats-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Role</th>
            <th>Regular</th>
            <th>Clinic</th>
            <th>Critical</th>
            <th>Total</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    userStats.forEach(user => {
      var total = user.regular + user.clinic + user.critical;
      var icon = getRoleIcon(user.role);
      
      html += `
        <tr>
          <td>${user.fullName}</td>
          <td><i class="fas ${icon}"></i> ${user.role}</td>
          <td>${user.regular}</td>
          <td>${user.clinic}</td>
          <td>${user.critical}</td>
          <td>${total}</td>
          <td>
            <button class="view-reports-btn" onclick="viewUserReports('${user.username}', '${user.fullName}')">
              <i class="fas fa-eye"></i> View
            </button>
          </td>
        </tr>
      `;
    });
    
    html += '</tbody></table>';
    userStatsContent.innerHTML = html;
  }

  function filterUserStats() {
    const input = document.getElementById('userStatsSearch');
    const filter = input.value.toLowerCase();
    const table = document.querySelector('.user-stats-table');
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 1; i < rows.length; i++) {
      const nameCell = rows[i].getElementsByTagName('td')[0];
      if (nameCell) {
        const name = nameCell.textContent || nameCell.innerText;
        if (name.toLowerCase().includes(filter)) {
          rows[i].style.display = '';
        } else {
          rows[i].style.display = 'none';
        }
      }
    }
  }

  function getRoleIcon(role) {
    const icons = {
      'Admin': 'fa-user-shield',
      'Teacher': 'fa-chalkboard-teacher',
      'Librarian': 'fa-book-reader',
      'Guidance': 'fa-user-graduate',
      'Clinic': 'fa-user-md',
      'Adviser': 'fa-user-tie'
    };
    return icons[role] || 'fa-user';
  }

  // ... existing code ...
  </script>

  <!-- Add Critical Incident Modal -->
  <div id="addCriticalModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('addCriticalModal')">&times;</span>
      <h2>Add Critical Incident</h2>
      <form id="criticalForm">
        <div class="form-section student-info">
          <h3>Student Information</h3>
          <div class="input-group">
            <label for="criticalStudentNumber" class="required-field">Student Number</label>
            <input type="text" id="criticalStudentNumber" name="criticalStudentNumber" required>
          </div>
          <div class="input-group">
            <label for="criticalGradeLevel" class="required-field">Grade Level</label>
            <select id="criticalGradeLevel" name="criticalGradeLevel" required>
              <option value="">Select Grade Level</option>
              <option value="Grade 7">Grade 7</option>
              <option value="Grade 8">Grade 8</option>
              <option value="Grade 9">Grade 9</option>
              <option value="Grade 10">Grade 10</option>
              <option value="Grade 11">Grade 11</option>
              <option value="Grade 12">Grade 12</option>
            </select>
          </div>
          <div class="input-group">
            <label for="criticalSection" class="required-field">Section</label>
            <input type="text" id="criticalSection" name="criticalSection" required>
          </div>
          <div class="input-group">
            <label for="criticalFirstName" class="required-field">First Name</label>
            <input type="text" id="criticalFirstName" name="criticalFirstName" required>
          </div>
          <div class="input-group">
            <label for="criticalLastName" class="required-field">Last Name</label>
            <input type="text" id="criticalLastName" name="criticalLastName" required>
          </div>
          <div class="input-group">
            <label for="criticalSuffix">Suffix</label>
            <input type="text" id="criticalSuffix" name="criticalSuffix">
          </div>
        </div>

        <div class="form-section">
          <h3>Critical Incident Details</h3>
          <div class="input-group">
            <label for="criticalIssuesConcern" class="required-field">Issues and Concern</label>
            <select id="criticalIssuesConcern" name="criticalIssuesConcern" required>
              <option value="">Select Issue/Concern</option>
              <option value="Suicidal Attempts or Suicidal Ideation">Suicidal Attempts or Suicidal Ideation</option>
              <option value="Bullying (Physical, Emotional, or Cyberbullying)">Bullying (Physical, Emotional, or Cyberbullying)</option>
              <option value="Self-Harm or Self-Injury">Self-Harm or Self-Injury</option>
              <option value="Physical Abuse or Domestic Violence">Physical Abuse or Domestic Violence</option>
              <option value="Drug Use or Substance Abuse">Drug Use or Substance Abuse</option>
              <option value="Sexual Harassment or Abuse">Sexual Harassment or Abuse</option>
              <option value="Severe Behavioral Problems (Aggression or Threats)">Severe Behavioral Problems (Aggression or Threats)</option>
              <option value="Truancy or Child Labor">Truancy or Child Labor</option>
              <option value="Teenage Pregnancy">Teenage Pregnancy</option>
              <option value="Mental Health Concerns (Severe Depression or Anxiety)">Mental Health Concerns (Severe Depression or Anxiety)</option>
            </select>
          </div>
        </div>

        <div class="form-section full-width">
          <div class="input-group">
            <label for="criticalDescription" class="required-field">Description</label>
            <textarea id="criticalDescription" name="criticalDescription" required></textarea>
          </div>
          <div class="input-group">
            <label for="criticalActionTaken" class="required-field">Action Taken</label>
            <textarea id="criticalActionTaken" name="criticalActionTaken" required></textarea>
          </div>
          <div class="input-group">
            <label for="criticalRecommendation" class="required-field">Recommendation</label>
            <textarea id="criticalRecommendation" name="criticalRecommendation" required></textarea>
          </div>
        </div>

        <input type="hidden" id="criticalReportedBy" name="criticalReportedBy">
        
        <div class="form-actions">
          <button type="button" class="cancel-btn" onclick="closeModal('addCriticalModal')">Cancel</button>
          <button type="button" class="submit-btn" onclick="submitCriticalReport()">Submit Critical Report</button>
        </div>
      </form>
    </div>
  </div>

  <!-- View Critical Incident Modal -->
  <div id="viewCriticalModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('viewCriticalModal')">&times;</span>
      <h2>View Critical Incidents</h2>
        
      <!-- Search and Filter Section -->
      <div class="search-filter-container">
        <!-- Date Filter -->
        <div class="date-filter">
          <div class="date-inputs">
            <div class="date-field">
              <label for="criticalStartDate">From:</label>
              <input type="date" id="criticalStartDate" name="criticalStartDate">
            </div>
            <div class="date-field">
              <label for="criticalEndDate">To:</label>
              <input type="date" id="criticalEndDate" name="criticalEndDate">
            </div>
          </div>
        </div>
        
        <!-- Search Input -->
        <div class="search-container">
          <input type="text" id="criticalSearchQuery" placeholder="Search by student number or name...">
          <button onclick="searchCriticalRecords()" class="filter-btn">
            <i class="fas fa-search"></i> Search
          </button>
        </div>
      </div>

      <!-- Records Display -->
      <div id="criticalRecordDetails" class="record-container"></div>
      <div class="navigation-buttons">
        <button id="criticalPrevButton" onclick="navigateCriticalRecord(-1)">Previous</button>
        <button id="criticalNextButton" onclick="navigateCriticalRecord(1)">Next</button>
      </div>
      <div id="criticalRecordIndicator" class="record-indicator"></div>
    </div>
  </div>

  <script>
  // Add these variables for Critical Incidents
  var criticalRecords = []; // Global variable to store critical incident search results
  var criticalCurrentIndex = 0; // Index to track the current critical incident record being displayed

  // Show modal for adding a critical incident
  function showAddCriticalModal() {
    document.getElementById('addCriticalModal').style.display = 'block';
    document.getElementById('criticalReportedBy').value = document.getElementById('userName').textContent;
  }

  // Show modal for viewing critical incidents
  function showViewCriticalModal() {
    document.getElementById('viewCriticalModal').style.display = 'block';
  }

  // Submit critical incident report
  function submitCriticalReport() {
    // Get all required fields
    const requiredFields = [
      { id: 'criticalStudentNumber', label: 'Student Number' },
      { id: 'criticalGradeLevel', label: 'Grade Level' },
      { id: 'criticalSection', label: 'Section' },
      { id: 'criticalFirstName', label: 'First Name' },
      { id: 'criticalLastName', label: 'Last Name' },
      { id: 'criticalIssuesConcern', label: 'Issues and Concern' },
      { id: 'criticalDescription', label: 'Description' },
      { id: 'criticalActionTaken', label: 'Action Taken' },
      { id: 'criticalRecommendation', label: 'Recommendation' }
    ];

    // Check if all required fields are filled
    for (const field of requiredFields) {
      const value = document.getElementById(field.id).value.trim();
      if (!value) {
        Swal.fire({
          icon: 'warning',
          title: 'Required Field Empty',
          text: `Please fill in the ${field.label} field`,
          confirmButtonColor: '#2193b0'
        });
        return;
      }
    }

    // Show loading state
    Swal.fire({
      title: 'Submitting Critical Incident',
      html: `
        <div class="login-progress">
          <i class="fas fa-exclamation-triangle" style="color: #2193b0; font-size: 50px; margin-bottom: 20px;"></i>
          <p style="margin: 10px 0;">Saving critical incident report...</p>
        </div>
      `,
      allowOutsideClick: false,
      showConfirmButton: false,
      willOpen: () => {
        Swal.showLoading();
      }
    });

    var criticalReportData = {
      studentNumber: document.getElementById('criticalStudentNumber').value,
      gradeLevel: document.getElementById('criticalGradeLevel').value,
      section: document.getElementById('criticalSection').value,
      firstName: document.getElementById('criticalFirstName').value,
      lastName: document.getElementById('criticalLastName').value,
      suffix: document.getElementById('criticalSuffix').value,
      issuesConcern: document.getElementById('criticalIssuesConcern').value,
      description: document.getElementById('criticalDescription').value,
      actionTaken: document.getElementById('criticalActionTaken').value,
      recommendation: document.getElementById('criticalRecommendation').value,
      reportedBy: document.getElementById('criticalReportedBy').value,
      reportDate: new Date().toISOString(),
      role: userRole
    };

    google.script.run
      .withSuccessHandler(function() {
        Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: 'Critical incident report has been successfully submitted',
          confirmButtonColor: '#2193b0',
          timer: 2000,
          timerProgressBar: true
        }).then(() => {
          document.getElementById('criticalForm').reset();
          closeModal('addCriticalModal');
          updateDashboardStats();
        });
      })
      .withFailureHandler(function(error) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to submit critical incident report. Please try again.',
          confirmButtonColor: '#2193b0'
        });
      })
      .saveCriticalReport(criticalReportData);
  }

  // Search critical incident records
  function searchCriticalRecords() {
    var query = document.getElementById('criticalSearchQuery').value;
    var startDate = document.getElementById('criticalStartDate').value;
    var endDate = document.getElementById('criticalEndDate').value;
    
    // Show loading
    Swal.fire({
      title: 'Searching Critical Incidents',
      text: 'Please wait...',
      allowOutsideClick: false,
      showConfirmButton: false,
      willOpen: () => {
        Swal.showLoading();
      }
    });

    google.script.run
      .withSuccessHandler(function(results) {
        Swal.close();
        criticalRecords = results;
        criticalCurrentIndex = 0;
        
        if (criticalRecords.length > 0) {
          displayCriticalRecord(0);
        } else {
          document.getElementById('criticalRecordDetails').innerHTML = '<div class="no-records">No critical incident records found.</div>';
          disableCriticalNavigation();
        }
      })
      .withFailureHandler(function(error) {
        Swal.close();
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to search critical incident records. Please try again.'
        });
      })
      .searchCriticalReports(query, startDate, endDate);
  }

  // Display critical incident record
  function displayCriticalRecord(index) {
    var recordDetails = document.getElementById('criticalRecordDetails');
    recordDetails.innerHTML = '';

  if (criticalRecords.length === 0) {
    recordDetails.innerHTML = '<div class="no-records">No critical incident records found.</div>';
    document.getElementById('criticalRecordIndicator').textContent = '';
    disableCriticalNavigation();
    return;
  }

    var record = criticalRecords[index];
    const recordDate = new Date(record[11]);
    const formattedDate = recordDate.toLocaleString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });

  var detailsHTML = `
    <div class="record-card">
      <div class="record-row">
        <div class="record-field"><strong>Student Number:</strong> ${record[0]}</div>
        <div class="record-field"><strong>Grade Level:</strong> ${record[1]}</div>
        <div class="record-field"><strong>Section:</strong> ${record[2]}</div>
      </div>

      <div class="record-row">
        <div class="record-field"><strong>First Name:</strong> ${record[3]}</div>
        <div class="record-field"><strong>Last Name:</strong> ${record[4]}</div>
        <div class="record-field"><strong>Suffix:</strong> ${record[5] || '-'}</div>
      </div>

      <div class="record-row full-width">
        <div class="record-field"><strong>Issues and Concern:</strong><br>${record[6]}</div>
      </div>

      <div class="record-row full-width">
        <div class="record-field"><strong>Description:</strong><br>${record[7]}</div>
      </div>

      <div class="record-row full-width">
        <div class="record-field"><strong>Action Taken:</strong><br>${record[8]}</div>
      </div>

      <div class="record-row full-width">
        <div class="record-field"><strong>Recommendation:</strong><br>${record[9]}</div>
      </div>

      <div class="record-row footer">
        <div class="record-field"><strong>Reported By:</strong> ${record[10]}</div>
        <div class="record-field"><strong>Date:</strong> ${formattedDate}</div>
      </div>
    </div>
  `;

  recordDetails.innerHTML = detailsHTML;
  document.getElementById('criticalRecordIndicator').textContent = `Record ${index + 1} of ${criticalRecords.length}`;
  document.getElementById('criticalPrevButton').disabled = (index === 0);
  document.getElementById('criticalNextButton').disabled = (index === criticalRecords.length - 1);
}

// Navigate between critical incident records
function navigateCriticalRecord(direction) {
  var newIndex = criticalCurrentIndex + direction;
  if (newIndex >= 0 && newIndex < criticalRecords.length) {
    criticalCurrentIndex = newIndex;
    displayCriticalRecord(criticalCurrentIndex);
  }
}

// Disable critical incident navigation buttons
function disableCriticalNavigation() {
  document.getElementById('criticalPrevButton').disabled = true;
  document.getElementById('criticalNextButton').disabled = true;
}

// Update the updateUIForRole function to include critical incident buttons
function updateUIForRole(role) {
  // Get all action buttons
  const addReportBtn = document.getElementById('addReportBtn');
  const viewReportBtn = document.getElementById('viewReportBtn');
  const addClinicReportBtn = document.getElementById('addClinicReportBtn');
  const viewClinicReportBtn = document.getElementById('viewClinicReportBtn');
  const addCriticalBtn = document.getElementById('addCriticalBtn');
  const viewCriticalBtn = document.getElementById('viewCriticalBtn');

  // Hide all buttons first
  if (addReportBtn) addReportBtn.style.display = 'none';
  if (viewReportBtn) viewReportBtn.style.display = 'none';
  if (addClinicReportBtn) addClinicReportBtn.style.display = 'none';
  if (viewClinicReportBtn) viewClinicReportBtn.style.display = 'none';
  if (addCriticalBtn) addCriticalBtn.style.display = 'none';
  if (viewCriticalBtn) viewCriticalBtn.style.display = 'none';

  // Show buttons based on role
  switch(role) {
    case 'Admin':
    case 'Head Teacher':
      // Show all buttons
      if (addReportBtn) addReportBtn.style.display = 'flex';
      if (viewReportBtn) viewReportBtn.style.display = 'flex';
      if (addClinicReportBtn) addClinicReportBtn.style.display = 'flex';
      if (viewClinicReportBtn) viewClinicReportBtn.style.display = 'flex';
      if (addCriticalBtn) addCriticalBtn.style.display = 'flex';
      if (viewCriticalBtn) viewCriticalBtn.style.display = 'flex';
      break;

    case 'Guidance':
      // Regular reports and both critical incident buttons
      if (addReportBtn) addReportBtn.style.display = 'flex';
      if (viewReportBtn) viewReportBtn.style.display = 'flex';
      if (addCriticalBtn) addCriticalBtn.style.display = 'flex';
      if (viewCriticalBtn) viewCriticalBtn.style.display = 'flex';
      break;

    case 'Adviser':
      // Regular reports, view clinic records, and add critical incidents
      if (addReportBtn) addReportBtn.style.display = 'flex';
      if (viewReportBtn) viewReportBtn.style.display = 'flex';
      if (viewClinicReportBtn) viewClinicReportBtn.style.display = 'flex';
      if (addCriticalBtn) addCriticalBtn.style.display = 'flex';
      break;

    case 'Teacher':
    case 'Librarian':
      // Only regular reports
      if (addReportBtn) addReportBtn.style.display = 'flex';
      if (viewReportBtn) viewReportBtn.style.display = 'flex';
      break;

    case 'Clinic':
      // Only clinic reports
      if (addClinicReportBtn) addClinicReportBtn.style.display = 'flex';
      if (viewClinicReportBtn) viewClinicReportBtn.style.display = 'flex';
      break;
  }
}

function displayCriticalSummary(summary) {
  const container = document.querySelector('.critical-summary-container');
  let html = `
    <div class="critical-summary">
      <div class="summary-date-filter">
        <div class="date-inputs">
          <div class="date-field">
            <label for="summaryStartDate">From:</label>
            <input type="date" id="summaryStartDate" name="summaryStartDate">
          </div>
          <div class="date-field">
            <label for="summaryEndDate">To:</label>
            <input type="date" id="summaryEndDate" name="summaryEndDate">
          </div>
        </div>
        <button onclick="updateCriticalSummary()" class="filter-btn">
          <i class="fas fa-filter"></i> Apply Filter
        </button>
      </div>

      <h3>Critical Incidents by Type</h3>
      <div class="critical-stats-grid">
  `;

  // Get total incidents
  const total = Object.values(summary).reduce((a, b) => a + b, 0);

  // Define icons for each type
  const icons = {
    "Suicidal Attempts or Suicidal Ideation": "fa-heart-broken",
    "Bullying (Physical, Emotional, or Cyberbullying)": "fa-angry",
    "Self-Harm or Self-Injury": "fa-band-aid",
    "Physical Abuse or Domestic Violence": "fa-hand-fist",
    "Drug Use or Substance Abuse": "fa-pills",
    "Sexual Harassment or Abuse": "fa-exclamation-triangle",
    "Severe Behavioral Problems (Aggression or Threats)": "fa-bolt",
    "Truancy or Child Labor": "fa-user-clock",
    "Teenage Pregnancy": "fa-baby",
    "Mental Health Concerns (Severe Depression or Anxiety)": "fa-brain"
  };

  // Sort issues by number of incidents (descending)
  const sortedIssues = Object.entries(summary)
    .sort(([,a], [,b]) => b - a);

  sortedIssues.forEach(([issue, count]) => {
    const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
    const icon = icons[issue] || "fa-exclamation-circle";
    
    html += `
      <div class="critical-stat-card ${count > 0 ? 'has-incidents' : ''}">
        <div class="stat-icon">
          <i class="fas ${icon}"></i>
        </div>
        <div class="stat-details">
          <h4>${issue}</h4>
          <div class="stat-numbers">
            <span class="count">${count}</span>
            <span class="percentage">(${percentage}%)</span>
          </div>
        </div>
      </div>
    `;
  });

  html += `
      </div>
      <div class="total-summary">
        <h4>Total Critical Incidents: ${total}</h4>
      </div>
    </div>
  `;

  container.innerHTML = html;
}

function updateCriticalSummary() {
  const startDate = document.getElementById('summaryStartDate').value;
  const endDate = document.getElementById('summaryEndDate').value;

  // Show loading state
  Swal.fire({
    title: 'Loading Statistics',
    html: 'Please wait...',
    allowOutsideClick: false,
    showConfirmButton: false,
    didOpen: () => {
      Swal.showLoading();
    }
  });

  google.script.run
    .withSuccessHandler(summary => {
      if (summary) {
        displayCriticalSummary(summary);
        Swal.close();
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to load statistics. Please try again.',
        });
      }
    })
    .withFailureHandler(error => {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Failed to load statistics: ' + error,
      });
    })
    .getCriticalIncidentsSummary(startDate, endDate);
}

// Add CSS styles for the summary date filter
const summaryFilterStyle = document.createElement('style');
summaryFilterStyle.textContent = `
  .summary-date-filter {
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 15px;
  }

  .summary-date-filter .date-inputs {
    display: flex;
    gap: 15px;
    flex: 1;
  }

  .summary-date-filter .date-field {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .summary-date-filter label {
    font-weight: bold;
    color: #2193b0;
  }

  .summary-date-filter input[type="date"] {
    padding: 8px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    flex: 1;
  }

  .summary-date-filter .filter-btn {
    padding: 8px 15px;
    background: #2193b0;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background-color 0.3s ease;
  }

  .summary-date-filter .filter-btn:hover {
    background: #1b7a94;
  }
`;

document.head.appendChild(summaryFilterStyle);

function openSearchStudent() {
      document.getElementById('searchStudentModal').style.display = 'block';
    }
  </script>
</body>
</html>
